<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interaktive Karte – Firmen & Kunden</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { --border:#e7e7e7; --muted:#666; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #wrap { display:flex; height:100vh; }
    #sidebar {
      width: 380px; max-width: 92vw; overflow:auto;
      border-right: 1px solid var(--border);
      padding: 14px 14px 18px;
      box-sizing: border-box;
      background:#fff;
    }
    #map { flex:1; }
    h1 { font-size: 16px; margin: 0 0 10px; }
    .row { display:flex; gap:8px; align-items:center; }
    .row > * { flex:1; }
    input[type="text"], select {
      width:100%; padding:10px; border:1px solid var(--border); border-radius:10px;
      box-sizing: border-box;
    }
    .box { border:1px solid var(--border); border-radius:14px; padding:10px; margin: 10px 0; }
    .muted { color: var(--muted); font-size: 12px; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .chip { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); cursor:pointer; user-select:none; }
    .chip.active { border-color:#111; background:#111; color:#fff; }
    button {
      padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#111; color:#fff; cursor:pointer;
    }
    button.secondary { background:#fff; color:#111; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .list { margin-top:10px; }
    .item {
      padding:10px; border:1px solid var(--border); border-radius:14px;
      margin-bottom:10px;
    }
    .item-title { font-weight:600; font-size: 14px; }
    .item-sub { font-size:12px; color:var(--muted); margin-top:2px; }
    .item-actions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .smallbtn { padding:8px 10px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .smallbtn.primary { background:#111; color:#fff; border-color:#111; }
    .hr { height:1px; background:var(--border); margin:10px 0; }
    .status { font-size:12px; color:var(--muted); }
    .warn { color:#b45309; }
    .badge { display:inline-block; font-size:11px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; margin-right:6px; }
  </style>
</head>

<body>
<div id="wrap">
  <div id="sidebar">
    <h1>Firmenkarte</h1>
    <div class="muted">Firmen + Kunden (Google Sheets CSV) • Route + Preis je Produkt</div>

    <div class="box">
      <div class="row">
        <input id="search" type="text" placeholder="Suche Firma / Ort / PLZ…" />
      </div>

      <div class="hr"></div>

      <div class="muted">Ansicht:</div>
      <div class="row" style="margin-top:6px;">
        <select id="mode">
          <option value="firmen" selected>Firmen</option>
          <option value="kunden">Kunden</option>
        </select>
      </div>

      <div class="hr"></div>

      <div class="muted">Produktfilter (nur Firmen):</div>
      <div class="chips" id="productChips"></div>

      <div class="hr"></div>

      <div class="muted">Zertifikate (nur Firmen, Spalte Q: 1=SURE, 2=PEFC):</div>
      <div class="chips">
        <span class="chip" id="chipSURE">SURE</span>
        <span class="chip" id="chipPEFC">PEFC</span>
      </div>

      <div class="hr"></div>

      <div class="muted">Route:</div>
      <div class="status" id="routeStatus">Wähle Start & Ziel aus der Liste (Firmen oder Kunden).</div>
      <div class="row" style="margin-top:10px;">
        <button id="clearRoute" class="secondary" disabled>Route löschen</button>
        <button id="fitAll" class="secondary">Alles anzeigen</button>
      </div>
    </div>

    <div class="status" id="status">Lade Daten…</div>
    <div class="list" id="list"></div>
  </div>

  <div id="map"></div>
</div>

<script>
/* =========================
   LINKS (EINGETRAGEN)
   ========================= */
const SHEETS_FIRMEN_CSV_URL =
  "https://docs.google.com/spreadsheets/d/1GIBV-WAyaslfi175jpbif0bHw8YWAhriifM7CtDUB2k/export?format=csv&gid=0";

const SHEETS_KUNDEN_CSV_URL =
  "https://docs.google.com/spreadsheets/d/148jjtRze9SmuFsDNRfoM_nwEih7GbCzOjMUQEAb78pg/export?format=csv&gid=0";

/* =========================
   PREIS-LOGIK (OPTIONAL)
   =========================
   Wenn du nur "Basispreis aus Tabelle" willst: rateProKm überall 0 lassen.
   Wenn du km-Zuschlag willst: Werte eintragen.
*/
const rateProKm = {
  "Hackschnitzel": 0,   // z.B. 0.12
  "Sägespäne": 0,       // z.B. 0.10
  "Saegespaene": 0,     // falls ohne Umlaut irgendwo vorkommt
  "Siebmaterial": 0     // z.B. 0.15
};

/* =========================
   LEAFLET INIT
   ========================= */
const map = L.map("map").setView([51.0, 10.0], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);
let routeLine = null;

/* =========================
   STATE
   ========================= */
let firmen = [];
let kunden = [];

let mode = "firmen";
let activeProducts = new Set(); // nur Firmen
let filterSURE = false;
let filterPEFC = false;

let startPick = null;
let endPick = null;

/* =========================
   HELPERS
   ========================= */
function setStatus(msg, warn=false) {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.className = "status" + (warn ? " warn" : "");
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeStr(s) {
  return String(s ?? "").trim();
}

function toNumber(val) {
  if (val === null || val === undefined) return NaN;
  const s = String(val).trim();
  if (!s) return NaN;
  const cleaned = s.replace("€", "").replace(/\s/g, "").replace(",", ".");
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}

function formatEUR(n) {
  return `${n.toFixed(2)} €`;
}

// Simple CSV parser (für Google CSV reicht das normal)
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i+1];

    if (c === '"' ) {
      if (inQuotes && next === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === "," && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((c === "\n" || c === "\r") && !inQuotes) {
      if (c === "\r" && next === "\n") i++;
      row.push(cur);
      rows.push(row);
      row = [];
      cur = "";
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }

  const header = rows.shift()?.map(h => h.trim()) ?? [];
  return rows
    .filter(r => r.some(cell => String(cell).trim() !== ""))
    .map(r => {
      const obj = {};
      header.forEach((h, idx) => obj[h] = r[idx] ?? "");
      return obj;
    });
}

/* =========================
   GEO: Address -> LatLng
   ========================= */
async function geocodeNominatim(query) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`;
  const res = await fetch(url, { headers: { "Accept": "application/json" } });
  if (!res.ok) return null;
  const data = await res.json();
  if (!data?.length) return null;
  return { lat: Number(data[0].lat), lon: Number(data[0].lon) };
}

function buildAddress(row) {
  // deine Spalten (vom Screenshot): plz, ort (enthält oft Straße), land
  const plz = normalizeStr(row.plz);
  const ort = normalizeStr(row.ort);
  const land = normalizeStr(row.land);
  return [ort, plz, land].filter(Boolean).join(", ");
}

/* =========================
   PRODUKTE aus deiner Struktur:
   produkt/preis, produkt_2/preis_2, ...
   ========================= */
function getProductsFromRow(row) {
  const products = [];
  for (let i = 1; i <= 4; i++) {
    const pKey = i === 1 ? "produkt" : `produkt_${i}`;
    const priceKey = i === 1 ? "preis" : `preis_${i}`;

    const name = normalizeStr(row[pKey]);
    const base = toNumber(row[priceKey]);

    if (name && Number.isFinite(base)) {
      products.push({ name, base });
    }
  }
  return products;
}

function getAllProductNamesFromFirmen(list) {
  const set = new Set();
  for (const f of list) {
    for (const p of getProductsFromRow(f)) set.add(p.name);
  }
  return Array.from(set).sort((a,b) => a.localeCompare(b, "de"));
}

/* =========================
   ZERTIFIKATE (Spalte Q)
   1 = SURE, 2 = PEFC
   (du hast gesagt: in Spalte Q stehen die Codes)
   ========================= */
function parseCerts(row) {
  // falls Header nicht "Q" heißt: ändere hier (z.B. "zertifikate")
  const raw = normalizeStr(row.Q ?? row.q ?? row.zertifikate ?? row.Zertifikate);
  const tokens = raw
    .split(/[,; ]+/)
    .map(t => t.trim())
    .filter(Boolean);

  const hasSURE = tokens.includes("1") || tokens.some(t => t.toLowerCase() === "sure");
  const hasPEFC = tokens.includes("2") || tokens.some(t => t.toLowerCase() === "pefc");

  return { hasSURE, hasPEFC };
}

/* =========================
   ROUTING (OSRM)
   ========================= */
async function fetchRoute(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  if (!res.ok) return null;
  const data = await res.json();
  if (!data?.routes?.length) return null;
  return data.routes[0];
}

function kmFromMeters(m) { return m / 1000; }
function minFromSeconds(s) { return s / 60; }

function formatDuration(sec) {
  const mins = Math.round(minFromSeconds(sec));
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (h <= 0) return `${m} min`;
  return `${h}h ${String(m).padStart(2, "0")}min`;
}

/* =========================
   PREISE anzeigen + berechnen
   ========================= */
function buildPriceLinesForPopup(row, distanceKm) {
  const prods = getProductsFromRow(row);

  if (!prods.length) return `<div class="muted">Keine Produkte eingetragen.</div>`;

  const lines = prods.map(p => {
    const r = rateProKm[p.name] ?? rateProKm[p.name.replaceAll("ä","ae").replaceAll("Ä","Ae")] ?? 0;
    const total = p.base + (distanceKm * r);
    return `<div><b>${escapeHtml(p.name)}:</b> ${formatEUR(total)}</div>`;
  });

  return lines.join("");
}

/* =========================
   UI + RENDER
   ========================= */
function renderProductChips() {
  const el = document.getElementById("productChips");
  el.innerHTML = "";

  if (mode !== "firmen") {
    el.innerHTML = `<span class="muted">Nur bei Firmen verfügbar.</span>`;
    return;
  }

  const products = getAllProductNamesFromFirmen(firmen);
  if (!products.length) {
    el.innerHTML = `<span class="muted">Keine Produkte gefunden.</span>`;
    return;
  }

  for (const name of products) {
    const chip = document.createElement("span");
    chip.className = "chip" + (activeProducts.has(name) ? " active" : "");
    chip.textContent = name;
    chip.onclick = () => {
      if (activeProducts.has(name)) activeProducts.delete(name);
      else activeProducts.add(name);
      renderAll();
    };
    el.appendChild(chip);
  }
}

function matchesSearch(row, q) {
  if (!q) return true;
  q = q.toLowerCase();
  const fields = [
    row.firma, row.plz, row.ort, row.land,
    row.kunde, row.name, row.adresse
  ].map(x => String(x ?? "").toLowerCase());
  return fields.some(v => v.includes(q));
}

function firmHasActiveProduct(row) {
  if (activeProducts.size === 0) return true;
  const names = getProductsFromRow(row).map(p => p.name);
  return names.some(n => activeProducts.has(n));
}

function firmMatchesCertFilter(row) {
  if (!filterSURE && !filterPEFC) return true;
  const c = parseCerts(row);
  if (filterSURE && !c.hasSURE) return false;
  if (filterPEFC && !c.hasPEFC) return false;
  return true;
}

function clearMarkers() {
  markersLayer.clearLayers();
}

function addMarkerForRow(row, kind) {
  // kind: "firma" | "kunde"
  const lat = toNumber(row.lat ?? row.latitude);
  const lon = toNumber(row.lon ?? row.lng ?? row.longitude);

  if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;

  const title = kind === "firma"
    ? normalizeStr(row.firma || row.name || "Firma")
    : normalizeStr(row.kunde || row.name || "Kunde");

  const addr = kind === "firma" ? buildAddress(row) : normalizeStr(row.ort || row.adresse || "");

  const cert = kind === "firma" ? parseCerts(row) : { hasSURE:false, hasPEFC:false };
  const badges = [];
  if (cert.hasSURE) badges.push(`<span class="badge">SURE</span>`);
  if (cert.hasPEFC) badges.push(`<span class="badge">PEFC</span>`);

  const productsHtml = kind === "firma"
    ? (() => {
        const ps = getProductsFromRow(row);
        if (!ps.length) return `<div class="muted">Keine Produkte</div>`;
        return ps.map(p => `<div>${escapeHtml(p.name)}: ${formatEUR(p.base)}</div>`).join("");
      })()
    : "";

  const popup = `
    <div style="min-width:240px">
      <div style="font-weight:700">${escapeHtml(title)}</div>
      <div class="muted" style="margin-top:2px">${escapeHtml(addr)}</div>
      ${badges.length ? `<div style="margin-top:8px">${badges.join("")}</div>` : ""}
      ${kind === "firma" ? `<div class="hr"></div>${productsHtml}` : ""}
    </div>
  `;

  const m = L.marker([lat, lon]).bindPopup(popup);
  m.addTo(markersLayer);
  return m;
}

function listItemHtml(row, kind) {
  const title = kind === "firma"
    ? normalizeStr(row.firma || row.name || "Firma")
    : normalizeStr(row.kunde || row.name || "Kunde");

  const addr = kind === "firma" ? buildAddress(row) : normalizeStr(row.ort || row.adresse || "");

  let meta = `<div class="item-sub">${escapeHtml(addr)}</div>`;

  if (kind === "firma") {
    const cert = parseCerts(row);
    const badges = [];
    if (cert.hasSURE) badges.push("SURE");
    if (cert.hasPEFC) badges.push("PEFC");
    if (badges.length) meta += `<div class="item-sub">Zertifikate: ${badges.join(", ")}</div>`;

    const prods = getProductsFromRow(row);
    if (prods.length) {
      meta += `<div class="item-sub">Produkte: ${prods.map(p => p.name).join(", ")}</div>`;
    }
  }

  return `
    <div class="item">
      <div class="item-title">${escapeHtml(title)}</div>
      ${meta}
      <div class="item-actions">
        <button class="smallbtn" data-action="zoom">Zoomen</button>
        <button class="smallbtn primary" data-action="start">Start</button>
        <button class="smallbtn primary" data-action="ziel">Ziel</button>
      </div>
    </div>
  `;
}

function getRowLatLon(row) {
  const lat = toNumber(row.lat ?? row.latitude);
  const lon = toNumber(row.lon ?? row.lng ?? row.longitude);
  if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
  return { lat, lon };
}

function updateRouteStatus() {
  const el = document.getElementById("routeStatus");
  const s = startPick ? startPick.title : "—";
  const z = endPick ? endPick.title : "—";
  el.textContent = `Start: ${s}  |  Ziel: ${z}`;
}

function clearRoute() {
  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
  startPick = null;
  endPick = null;
  updateRouteStatus();
  document.getElementById("clearRoute").disabled = true;
}

async function buildRouteIfReady() {
  if (!startPick || !endPick) return;

  const a = startPick.ll;
  const b = endPick.ll;

  const route = await fetchRoute(a, b);
  if (!route) {
    alert("Route konnte nicht berechnet werden.");
    return;
  }

  const coords = route.geometry.coordinates.map(([lon, lat]) => [lat, lon]);
  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(coords, { weight: 5 }).addTo(map);

  const bounds = routeLine.getBounds();
  map.fitBounds(bounds.pad(0.15));

  const distanceKm = kmFromMeters(route.distance);
  const duration = formatDuration(route.duration);

  // Popup: Preise nur wenn Ziel/Start eine Firma ist
  const startIsFirma = startPick.kind === "firma";
  const endIsFirma = endPick.kind === "firma";

  let pricesHtml = "";
  // Wenn Start eine Firma ist: nimm deren Produkte
  if (startIsFirma) pricesHtml = buildPriceLinesForPopup(startPick.row, distanceKm);
  // sonst wenn Ziel eine Firma ist: nimm deren Produkte
  else if (endIsFirma) pricesHtml = buildPriceLinesForPopup(endPick.row, distanceKm);

  const popupHtml = `
    <div style="min-width:260px">
      <div><b>Route:</b> ${escapeHtml(startPick.title)} ↔ ${escapeHtml(endPick.title)}</div>
      <div class="hr"></div>
      <div><b>Entfernung:</b> ${distanceKm.toFixed(1)} km</div>
      <div><b>Dauer:</b> ${escapeHtml(duration)}</div>
      ${pricesHtml ? `<div class="hr"></div>${pricesHtml}` : ""}
    </div>
  `;

  routeLine.bindPopup(popupHtml).openPopup();

  document.getElementById("clearRoute").disabled = false;
}

/* =========================
   RENDER ALL
   ========================= */
function renderAll() {
  clearMarkers();

  const q = normalizeStr(document.getElementById("search").value);
  const listEl = document.getElementById("list");
  listEl.innerHTML = "";

  const data = (mode === "firmen") ? firmen : kunden;
  const kind = (mode === "firmen") ? "firma" : "kunde";

  const filtered = data.filter(row => {
    if (!matchesSearch(row, q)) return false;

    if (mode === "firmen") {
      if (!firmHasActiveProduct(row)) return false;
      if (!firmMatchesCertFilter(row)) return false;
    }
    return true;
  });

  const markers = [];
  for (const row of filtered) {
    const m = addMarkerForRow(row, kind);
    if (m) markers.push(m);
  }

  // Liste bauen
  for (const row of filtered) {
    const itemWrap = document.createElement("div");
    itemWrap.innerHTML = listItemHtml(row, kind);

    const item = itemWrap.firstElementChild;
    const ll = getRowLatLon(row);

    // falls kein lat/lon: warn in UI
    if (!ll) {
      const sub = item.querySelector(".item-sub");
      if (sub) sub.innerHTML += `<div class="item-sub warn">⚠️ Kein lat/lon in Tabelle (oder nicht numerisch)</div>`;
    }

    item.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", async () => {
        const action = btn.getAttribute("data-action");
        if (!ll) {
          alert("Für diesen Eintrag fehlen lat/lon. Entweder Spalten hinzufügen oder Geocoding einbauen.");
          return;
        }

        const title = (kind === "firma")
          ? normalizeStr(row.firma || row.name || "Firma")
          : normalizeStr(row.kunde || row.name || "Kunde");

        if (action === "zoom") {
          map.setView([ll.lat, ll.lon], 11);
        }

        if (action === "start") {
          startPick = { title, ll, kind, row };
          updateRouteStatus();
          await buildRouteIfReady();
        }

        if (action === "ziel") {
          endPick = { title, ll, kind, row };
          updateRouteStatus();
          await buildRouteIfReady();
        }
      });
    });

    listEl.appendChild(item);
  }

  setStatus(`${filtered.length} ${mode === "firmen" ? "Firmen" : "Kunden"} angezeigt.`);
}

/* =========================
   LOAD DATA
   ========================= */
async function loadSheetCSV(url) {
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`CSV konnte nicht geladen werden: ${res.status}`);
  const text = await res.text();
  return parseCSV(text);
}

async function init() {
  try {
    setStatus("Lade Firmen…");
    firmen = await loadSheetCSV(SHEETS_FIRMEN_CSV_URL);

    setStatus("Lade Kunden…");
    kunden = await loadSheetCSV(SHEETS_KUNDEN_CSV_URL);

    // Produktchips nur aus Firmen
    renderProductChips();

    // Erstes rendern
    renderAll();
  } catch (e) {
    console.error(e);
    setStatus("Fehler beim Laden. Prüfe: Freigabe der Sheets + CSV-Link.", true);
    alert("Fehler beim Laden der Daten. Prüfe, ob die Google Sheets öffentlich (Jeder mit Link) sind.");
  }
}

/* =========================
   EVENTS
   ========================= */
document.getElementById("search").addEventListener("input", () => renderAll());

document.getElementById("mode").addEventListener("change", (e) => {
  mode = e.target.value;
  // Route resetten wenn Modus gewechselt
  clearRoute();

  // Produktchips nur im Firmen-Modus aktiv anzeigen
  renderProductChips();
  renderAll();
});

document.getElementById("chipSURE").addEventListener("click", (e) => {
  filterSURE = !filterSURE;
  e.target.classList.toggle("active", filterSURE);
  renderAll();
});
document.getElementById("chipPEFC").addEventListener("click", (e) => {
  filterPEFC = !filterPEFC;
  e.target.classList.toggle("active", filterPEFC);
  renderAll();
});

document.getElementById("clearRoute").addEventListener("click", () => clearRoute());

document.getElementById("fitAll").addEventListener("click", () => {
  const bounds = [];
  markersLayer.eachLayer(l => {
    if (l.getLatLng) bounds.push(l.getLatLng());
  });
  if (!bounds.length) return;
  map.fitBounds(L.latLngBounds(bounds).pad(0.2));
});

updateRouteStatus();
init();
</script>

</body>
</html>
