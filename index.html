<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Europa Preiskarte ‚Äì Unit Auswahl</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body{height:100%;margin:0}
    #map{height:100%;width:100%}

    .box{
      position:absolute;background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial;
      z-index:2000
    }

    .search{top:12px;right:12px;width:280px}
    .legend{bottom:12px;right:12px;min-width:180px;z-index:3000}
    .cert{bottom:12px;left:12px;z-index:2500}

    .box input[type="checkbox"]{width:14px;height:14px;margin-right:5px;vertical-align:middle}
    .search input, .search select{
      width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;
      outline:none;box-sizing:border-box;margin-top:6px;
    }
    .cert hr{border:none;height:1px;background:#eee;margin:6px 0}

    .dd{position:relative;display:block;width:100%;margin-top:8px}
    .ddbtn{width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;padding:4px 6px;text-align:left;cursor:pointer;box-sizing:border-box}
    .ddbtn:after{content:"‚ñæ";float:right;opacity:.6}
    .ddm{
      position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;border-radius:4px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
      z-index:4000;display:none;min-width:160px;max-height:260px;overflow:auto;padding:6px 8px;box-sizing:border-box
    }
    .ddm label{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;margin:0;white-space:nowrap}

    /* Panels erstmal aus */
    #panelPellets, #legendPellets, #panelSaegerestholz, #legendSaegerestholz { display:none; }

    /* ===== Rechtsklick-Box (Pellets Zielpreis-Men√º) ===== */
    .ctxbox{
      position:absolute; z-index:6000;
      background:#fff; border-radius:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
      padding:10px; width:280px;
      font:14px/1.25 system-ui, Arial;
      border:1px solid rgba(0,0,0,.10);
    }
    .ctxbox b{display:block;margin-bottom:6px}
    .ctxbox .row{display:flex; gap:8px; margin:8px 0}
    .ctxbox select,.ctxbox input{
      width:100%; padding:7px 8px; border:1px solid #ccc; border-radius:6px;
      outline:none; box-sizing:border-box;
    }
    .ctxbox .results{
      margin-top:8px; max-height:240px; overflow:auto;
      border-top:1px solid #eee; padding-top:8px;
    }
    .ctxbox .item{
      padding:8px; border:1px solid #eee; border-radius:8px; cursor:pointer;
      margin:6px 0;
    }
    .ctxbox .item:hover{background:#fafafa}
    .ctxbox .small{font-size:12px;opacity:.75}
    .ctxbox .pill{
      display:inline-block; padding:2px 6px; border-radius:999px;
      background:#f2f2f2; font-size:12px; margin-left:6px;
    }
    .ctxbox .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .ctxbox .xbtn{
      border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;
      padding:2px 8px; line-height:1.6;
    }
  </style>
</head>

<body>
<div id="map"></div>

<!-- SEARCH + COUNTRY + UNIT -->
<div class="box search">
  üîç <input id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶">

  <b style="display:block;margin-top:6px">Land / L√§nder filtern</b>
  <div class="dd" id="countryDropdown">
    <div class="ddbtn" id="countryDropdownBtn">Alle L√§nder</div>
    <div class="ddm" id="countryDropdownMenu">
      <label><input type="checkbox" class="countryChk" value="all" checked> Alle</label>
      <label><input type="checkbox" class="countryChk" value="be"> Belgien</label>
      <label><input type="checkbox" class="countryChk" value="dk"> D√§nemark</label>
      <label><input type="checkbox" class="countryChk" value="de"> Deutschland</label>
      <label><input type="checkbox" class="countryChk" value="ee"> Estland</label>
      <label><input type="checkbox" class="countryChk" value="fi"> Finnland</label>
      <label><input type="checkbox" class="countryChk" value="fr"> Frankreich</label>
      <label><input type="checkbox" class="countryChk" value="it"> Italien</label>
      <label><input type="checkbox" class="countryChk" value="lv"> Lettland</label>
      <label><input type="checkbox" class="countryChk" value="lt"> Litauen</label>
      <label><input type="checkbox" class="countryChk" value="nl"> Niederlande</label>
      <label><input type="checkbox" class="countryChk" value="at"> √ñsterreich</label>
      <label><input type="checkbox" class="countryChk" value="pl"> Polen</label>
      <label><input type="checkbox" class="countryChk" value="se"> Schweden</label>
      <label><input type="checkbox" class="countryChk" value="ch"> Schweiz</label>
      <label><input type="checkbox" class="countryChk" value="sk"> Slowakei</label>
      <label><input type="checkbox" class="countryChk" value="cz"> Tschechien</label>
      <label><input type="checkbox" class="countryChk" value="gb"> United Kingdom</label>
    </div>
  </div>

  <b style="display:block;margin-top:10px">Unit</b>
  <select id="unitSelect">
    <option value="" selected>Bitte ausw√§hlen‚Ä¶</option>
    <option value="pellets">Pellets</option>
    <option value="saegerestholz">S√§gerestholz</option>
  </select>
</div>

<!-- ============ PELLETS PANEL ============ -->
<div class="box cert" id="panelPellets">
  <b>Zertifikate & Sackware</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkCPP" checked> CPP</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
  <hr>
  <b>Sackware</b><br>
  <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
  <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
</div>

<div class="box legend" id="legendPellets">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Pelleth√§ndler</label><br>
  <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren H√§ndler</label><br>
  <label><input type="checkbox" id="chkSonstigeKunden" checked> üî∂ Sonstige Kunden</label>
</div>

<!-- ============ S√ÑGERESTHOLZ PANEL (simple placeholder) ============ -->
<div class="box cert" id="panelSaegerestholz">
  <b>S√§gerestholz</b><br>
  <div style="opacity:.75;font-size:12px;margin-top:4px">
    (Hier k√∂nnen wir deine gro√üen S√§gerestholz-Filter sp√§ter wieder einbauen.)
  </div>
</div>
<div class="box legend" id="legendSaegerestholz">
  <b>Info</b><br>
  <div style="opacity:.75;font-size:12px;margin-top:4px">
    Klick 2 Punkte ‚Üí Route.
  </div>
</div>

<script>
/* =========================================================
   MAP
========================================================= */
const map = L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  minZoom:4,maxZoom:18,attribution:"&copy; OpenStreetMap"
}).addTo(map);

/* =========================================================
   L√ÑNDER UI
========================================================= */
const lc = s => String(s ?? "").toLowerCase().trim();

function getSelectedCountries(){
  const s=[...document.querySelectorAll(".countryChk")].filter(c=>c.checked).map(c=>c.value);
  return (!s.length||s.includes("all"))?["all"]:s;
}
function updateCountryButtonLabel(){
  const s=getSelectedCountries(), btn=document.getElementById("countryDropdownBtn");
  if(s.length===1&&s[0]==="all") return btn.textContent="Alle L√§nder";
  const names={be:"BE",dk:"DK",de:"DE",ee:"EE",fi:"FI",fr:"FR",it:"IT",lv:"LV",lt:"LT",nl:"NL",at:"AT",pl:"PL",se:"SE",ch:"CH",sk:"SK",cz:"CZ",gb:"UK"};
  btn.textContent=s.map(c=>names[c]||c.toUpperCase()).join(", ");
}
countryDropdownBtn.addEventListener("click",()=>countryDropdownMenu.style.display=(countryDropdownMenu.style.display==="block"?"none":"block"));
document.addEventListener("click",e=>{if(!countryDropdown.contains(e.target)) countryDropdownMenu.style.display="none"});
document.addEventListener("change", (e)=>{
  if(e.target?.classList?.contains("countryChk")){
    if(e.target.value==="all"&&e.target.checked) [...document.querySelectorAll(".countryChk")].forEach(x=>x.value!=="all"&&(x.checked=false));
    if(e.target.value!=="all"&&e.target.checked) document.querySelector('.countryChk[value="all"]').checked=false;
    updateCountryButtonLabel();
    if(currentUnit?.updateLayers) currentUnit.updateLayers();
  }
});

/* =========================================================
   UNIT MANAGER
========================================================= */
let currentUnit=null;

function hidePanels(){
  panelPellets.style.display="none"; legendPellets.style.display="none";
  panelSaegerestholz.style.display="none"; legendSaegerestholz.style.display="none";
}

function clearUnit(){
  if(!currentUnit) return;
  currentUnit.destroy?.();
  currentUnit = null;
}

unitSelect.addEventListener("change", async ()=>{
  const v = unitSelect.value;
  clearUnit();
  hidePanels();

  if(!v) return;

  if(v==="pellets"){
    panelPellets.style.display="block";
    legendPellets.style.display="block";
    currentUnit = createPelletsUnit();
  }
  if(v==="saegerestholz"){
    panelSaegerestholz.style.display="block";
    legendSaegerestholz.style.display="block";
    currentUnit = createSaegerestholzUnit();
  }

  try{ await currentUnit.init(); }
  catch(err){ console.error(err); alert("Fehler beim Laden der Unit. (F12 Konsole)"); }
});

/* =========================================================
   SUCHEN -> delegiert an Unit
========================================================= */
searchInput.addEventListener("keydown", async (e)=>{
  if(e.key!=="Enter") return;
  const q = (e.target.value||"").trim();
  if(!q) return;
  if(!currentUnit){ alert("Bitte zuerst eine Unit ausw√§hlen."); return; }
  try{ await currentUnit.search(q); }
  catch(err){ console.error(err); alert("Fehler bei Suche."); }
});

/* =========================================================
   PELLETS UNIT (DEIN CODE -> als Unit verpackt)
========================================================= */
function createPelletsUnit(){
  /*** ====== CSV LINKS (DEINE) ====== ***/
  const sheetUrlFirmen = "https://docs.google.com/spreadsheets/d/1fNUc0LJqBXxJdW1JRDfYxYORMuqeks_bHqp7zUq5Zmk/export?format=csv&gid=0";
  const sheetUrlKunden = "https://docs.google.com/spreadsheets/d/1fK_rO1b2eI4sOvUKOufVgmd2lQ85KazPf5Kfm4Iia5I/export?format=csv&gid=0";

  const geoCache=JSON.parse(localStorage.getItem("geoCachePellets_EU")||"{}");
  const saveGeo=()=>localStorage.setItem("geoCachePellets_EU",JSON.stringify(geoCache));
  const num=v=>{v=String(v??"").trim().replace(",",".");v=v.replace(/‚Ç¨/g,"").trim();const n=+v;return isFinite(n)?n:NaN};
  const str=v=>String(v??"").trim();
  const sackAktiv=()=>chkSackFireflies.checked||chkSack15kg.checked;

  function colorForPrice(p,kein){if(kein||!isFinite(p)||p<=0)return"#9e9e9e";if(p<=260)return"green";if(p<285)return"orange";return"red"}

  async function geocode(q){
    if(geoCache[q]?.country_code) return geoCache[q];
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
    const d=await r.json(); if(!d.length) return null;
    const a=d[0].address||{}, o={lat:+d[0].lat,lon:+d[0].lon,country:a.country||"",country_code:(a.country_code||"").toLowerCase()};
    geoCache[q]=o; saveGeo(); return o;
  }

  const tri=(fill)=>L.divIcon({className:"t",html:`<svg width="24" height="24" viewBox="0 0 24 24"><polygon points="12,2 22,22 2,22" fill="${fill}" stroke="black" stroke-width="1"/></svg>`,iconAnchor:[12,22],popupAnchor:[0,-20]});
  const iconBlue=tri("blue"), iconPurple=tri("purple"), iconOrange=tri("orange");

  let werke=[], kunden=[], alleMarker=[], selectedPoints=[], routeLine=null, searchMarker=null;
  let ctxEl=null, ctxCustomer=null, matchMarkers=[];

  function closeCtx(){ if(ctxEl){ctxEl.remove(); ctxEl=null;} ctxCustomer=null; }
  function resetMatchHighlights(){
    for(const m of matchMarkers){
      try{ if(m.marker.setStyle && m._origStyle) m.marker.setStyle(m._origStyle); }catch(e){}
    }
    matchMarkers=[];
  }

  function stopEvt(el){
    if(!el) return;
    L.DomEvent.disableClickPropagation(el);
    L.DomEvent.disableScrollPropagation(el);
    el.addEventListener("mousedown", e=>e.stopPropagation());
    el.addEventListener("click", e=>e.stopPropagation());
    el.addEventListener("dblclick", e=>e.stopPropagation());
    el.addEventListener("contextmenu", e=>e.stopPropagation());
    el.addEventListener("wheel", e=>e.stopPropagation(), {passive:true});
    el.addEventListener("touchstart", e=>e.stopPropagation(), {passive:true});
  }

  function findIndex(headers, cands){
    const hs=headers.map(h=>lc(h));
    const cs=cands.map(c=>lc(c));
    return hs.findIndex(h=>cs.includes(h));
  }

  function parseFirmenArray(table){
    if(!table || table.length<2) return [];
    const headers=(table[0]||[]).map(x=>str(x));
    const rows=table.slice(1);

    let nameIdx = findIndex(headers, ["firma","name","werk"]); if(nameIdx<0) nameIdx = 0;
    let ortIdx  = findIndex(headers, ["ort","stadt","standort","adresse","location"]); if(ortIdx<0) ortIdx = 1;

    const preisIdx = 2; // Spalte C (wie in deinem Code)

    let sackIdx = findIndex(headers, ["sackwarenpreis","sackwarepreis","preis_sack","sackpreis","preis sack"]);
    if(sackIdx<0) sackIdx = 3;

    let zertIdx = findIndex(headers, ["zertifikat","zertifikate","zert","cert"]); if(zertIdx<0) zertIdx = -1;
    let sackTxtIdx = findIndex(headers, ["sackware","sack","bag","bagged"]); if(sackTxtIdx<0) sackTxtIdx = -1;

    return rows
      .filter(r=>str(r[nameIdx]) && str(r[ortIdx]))
      .map(r=>{
        const p = num(r[preisIdx]);
        const ps = num(r[sackIdx]);
        return {
          firma: str(r[nameIdx]),
          ort: str(r[ortIdx]),
          preis: p,
          preisSack: ps,
          zert: zertIdx>=0 ? str(r[zertIdx]) : "",
          sack: sackTxtIdx>=0 ? str(r[sackTxtIdx]) : "",
          _preisOrig: p,
          _preisSackOrig: ps
        };
      });
  }

  function parseKunden(rows){
    const keys=Object.keys(rows[0]||{}),
      nameKey=(keys.find(k=>["name","kunde","kundenname"].includes(lc(k)))||keys[0]),
      ortKey=(keys.find(k=>["ort","adresse","standort","anschrift","stadt","location"].includes(lc(k)))||keys[1]),
      loseKey=(keys.find(k=>lc(k)==="lose")||"lose"),
      sackKey=(keys.find(k=>lc(k)==="sackware")||"sackware"),
      sonstKey=(keys.find(k=>lc(k)==="sonstige")||"sonstige");
    return rows.map(x=>({name:str(x[nameKey]),ort:str(x[ortKey]),lose:lc(x[loseKey]),sackware:lc(x[sackKey]),sonstige:lc(x[sonstKey])})).filter(x=>x.name&&x.ort);
  }

  function normalizePreise(d){
    const w=d.filter(x=>isFinite(x.preis)&&x.preis>0);
    const s=d.filter(x=>isFinite(x.preisSack)&&x.preisSack>0);
    const avgW=w.length?w.reduce((a,b)=>a+b.preis,0)/w.length:0;
    const avgS=s.length?s.reduce((a,b)=>a+b.preisSack,0)/s.length:0;

    return d.map(x=>{
      x.keinPreisWerk = !(isFinite(x._preisOrig) && x._preisOrig>0);
      x.keinPreisSack = !(isFinite(x._preisSackOrig) && x._preisSackOrig>0);

      if(x.keinPreisWerk) x.preis = avgW;
      if(x.keinPreisSack) x.preisSack = avgS;

      x.farbeWerk = colorForPrice(x._preisOrig, x.keinPreisWerk);
      x.farbeSack = colorForPrice(x._preisSackOrig, x.keinPreisSack);
      return x;
    });
  }

  function tooltipFirma(m){
    const useSack=sackAktiv();
    const p = useSack ? (m.keinPreisSack ? NaN : m._preisSackOrig) : (m.keinPreisWerk ? NaN : m._preisOrig);
    const preisTxt = (isFinite(p)&&p>0) ? `${p.toFixed(2)} ‚Ç¨` : "‚Äì";
    const z=m.zert?`<br><b>Zertifikat:</b> ${m.zert}`:"";
    const s=m.sack?`<br><b>Sackware:</b> ${m.sack}`:"";
    return `<b>${m.firma}</b><br>${m.ort}<br>${preisTxt}${z}${s}`;
  }

  async function ladeDaten(){
    const pF=new Promise(res=>Papa.parse(sheetUrlFirmen,{
      download:true, header:false, skipEmptyLines:true,
      complete:r=>{ try{ res(normalizePreise(parseFirmenArray(r.data||[]))) }catch(e){ res([]) } }
    }));
    const pK=new Promise(res=>Papa.parse(sheetUrlKunden,{
      download:true, header:true,
      complete:r=>{ try{ res(parseKunden(r.data||[])) }catch(e){ res([]) } }
    }));
    [werke,kunden]=await Promise.all([pF,pK]);
  }

  function luftlinieKm(a,b){
    const R=6371,toRad=x=>x*Math.PI/180, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon), la1=toRad(a.lat), la2=toRad(b.lat);
    const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
  }
  async function osrmDistKm(a,b){
    const url=`https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
    const res=await fetch(url);
    const data=res.ok?await res.json():null;
    if(data?.routes?.length) return data.routes[0].distance/1000;
    return null;
  }
  function calcDeliveredPrice(distKm, basePrice){
    const preisProKm = distKm < 250 ? 2.15 : 1.85;
    const berechnung = (distKm/24) * preisProKm;
    const total = (berechnung + (basePrice||0)) * 1.05;
    return { total, preisProKm };
  }

  async function showRouteByCoords(aLabel,aCoord,bLabel,bCoord){
    const osrm=`https://router.project-osrm.org/route/v1/driving/${aCoord.lon},${aCoord.lat};${bCoord.lon},${bCoord.lat}?overview=full&geometries=geojson`;
    let distKm=null, coords=null, dashed=false, durStr="";
    try{
      const res=await fetch(osrm);
      const data=res.ok?await res.json():null;
      if(data?.routes?.length){
        const r=data.routes[0];
        distKm=r.distance/1000;
        const min=r.duration/60, h=Math.floor(min/60), m=Math.round(min%60);
        durStr=h?`${h}h ${m}min`:`${m}min`;
        coords=r.geometry.coordinates.map(c=>[c[1],c[0]]);
      }
    }catch(e){}
    if(!distKm){
      distKm=luftlinieKm(aCoord,bCoord);
      coords=[[aCoord.lat,aCoord.lon],[bCoord.lat,bCoord.lon]];
      dashed=true;
    }

    const useSack = sackAktiv();
    const firm = werke.find(w=>w.firma===aLabel || w.firma===bLabel);
    const base = firm ? (useSack ? firm.preisSack : firm.preis) : 0;

    const {total, preisProKm} = calcDeliveredPrice(distKm, base);

    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline(coords,{color:"blue",weight:5,opacity:.85,dashArray:dashed?"8 8":null}).addTo(map);

    const mid=coords[Math.floor(coords.length/2)];
    L.popup().setLatLng(mid).setContent(`
      <b>Route:</b> ${aLabel} ‚Üî ${bLabel}<br>
      <b>Entfernung:</b> ${distKm.toFixed(1)} km ${dashed?"(Luftlinie)":"(Stra√üe)"}<br>
      ${durStr?`<b>Dauer:</b> ${durStr}<br>`:""}
      <b>Preis pro km:</b> ${preisProKm.toFixed(2)} ‚Ç¨<br>
      <b>${useSack?"Sackware-Preis":"Werkspreis"}:</b> ${(base||0).toFixed(2)} ‚Ç¨<br>
      <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${total.toFixed(2)} ‚Ç¨</span>
      ${dashed?`<br><small>Keine Stra√üenroute verf√ºgbar ‚Üí Luftlinie gestrichelt.</small>`:""}
    `).openOn(map);

    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
  }

  function clearRoute(){
    if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
    map.closePopup();
    selectedPoints=[];
  }

  function pickPoint(label,coord){
    selectedPoints.push({label,coord});
    if(selectedPoints.length===2){const [a,b]=selectedPoints; selectedPoints=[]; showRouteByCoords(a.label, a.coord, b.label, b.coord);}
  }

  function openCustomerMenu(kunde, coord, mouseEvent){
    closeCtx(); resetMatchHighlights();
    ctxCustomer = {name:kunde.name, ort:kunde.ort, coord};

    const p = map.mouseEventToContainerPoint(mouseEvent);
    const cont = map.getContainer();

    ctxEl = document.createElement("div");
    ctxEl.className = "ctxbox";
    ctxEl.style.left = Math.min(Math.max(10, p.x), cont.clientWidth-300) + "px";
    ctxEl.style.top  = Math.min(Math.max(10, p.y), cont.clientHeight-320) + "px";

    ctxEl.innerHTML = `
      <div class="topbar">
        <div style="min-width:0">
          <b style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.name}</b>
          <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.ort}</div>
        </div>
        <button class="xbtn" id="ctxClose">√ó</button>
      </div>

      <div class="row" style="margin-top:10px">
        <select id="ctxType">
          <option value="lose">Pellets lose</option>
          <option value="sack">Sackware</option>
        </select>
      </div>

      <div class="row">
        <input id="ctxPrice" type="number" step="0.01" placeholder="Zielpreis (‚Ç¨) eingeben‚Ä¶">
      </div>

      <div class="results" id="ctxResults"></div>
    `;

    cont.appendChild(ctxEl);
    stopEvt(ctxEl);

    ctxEl.querySelector("#ctxClose").addEventListener("click", closeCtx);
    const input = ctxEl.querySelector("#ctxPrice");
    input.focus();

    input.addEventListener("keydown", async (e)=>{
      if(e.key !== "Enter") return;
      const target = num(input.value);
      const type = ctxEl.querySelector("#ctxType").value;
      if(!isFinite(target) || target<=0){ alert("Bitte einen g√ºltigen Zielpreis eingeben."); return; }
      await runTargetSearch(type, target);
    });
  }

  async function runTargetSearch(type, targetPrice){
    if(!ctxEl || !ctxCustomer) return;
    const resBox = ctxEl.querySelector("#ctxResults");
    resBox.innerHTML = `<div class="small">Suche‚Ä¶</div>`;

    const firmsVisible = alleMarker
      .filter(m => m.type==="firma" && map.hasLayer(m.marker))
      .map(m => ({...m, base: (type==="sack" ? m.preisSack : m.preis)}))
      .filter(m => isFinite(m.base) && m.base>0);

    const c = ctxCustomer.coord;
    const pre = firmsVisible.map(f=>{
      const d0 = luftlinieKm({lat:c.lat,lon:c.lon},{lat:f._coord.lat,lon:f._coord.lon});
      return {...f, d0};
    }).sort((a,b)=>a.d0-b.d0);

    const LIMIT = 40;
    const candidates = pre.slice(0, Math.min(LIMIT, pre.length));

    const matches = [];
    for(const f of candidates){
      let dist = null;
      try{ dist = await osrmDistKm({lat:c.lat,lon:c.lon},{lat:f._coord.lat,lon:f._coord.lon}); }catch(e){}
      if(!dist) dist = f.d0;
      const {total, preisProKm} = calcDeliveredPrice(dist, f.base);
      if(total <= targetPrice) matches.push({ f, distKm: dist, total, preisProKm });
    }

    matches.sort((a,b)=>a.total-b.total);

    if(!matches.length){
      resBox.innerHTML = `<div class="small">Keine Firma unter ${targetPrice.toFixed(2)} ‚Ç¨ gefunden (in den n√§chsten ${LIMIT} nach N√§he).</div>`;
      return;
    }

    resetMatchHighlights();
    for(const m of matches.slice(0,12)){
      const mm = m.f;
      if(mm.marker.setStyle){
        mm._origStyle = {color:mm.marker.options.color, fillColor:mm.marker.options.fillColor, fillOpacity:mm.marker.options.fillOpacity};
        mm.marker.setStyle({color:"#000", fillColor:"#000", fillOpacity:0.85});
        matchMarkers.push(mm);
      }
    }

    const html = matches.slice(0,20).map((m,i)=>`
      <div class="item" data-i="${i}">
        <div><b>${m.f.firma}</b><span class="pill">${type==="sack"?"Sackware":"Lose"}</span></div>
        <div class="small">${m.f.ort}</div>
        <div class="small"><b>Entfernung:</b> ${m.distKm.toFixed(1)} km</div>
        <div class="small"><b>Werkpreis:</b> ${m.f.base.toFixed(2)} ‚Ç¨</div>
        <div><b>Lieferpreis:</b> ${m.total.toFixed(2)} ‚Ç¨</div>
      </div>
    `).join("");

    resBox.innerHTML = html + `<div class="small">Zeige ${Math.min(20,matches.length)} von ${matches.length} Treffern.</div>`;

    [...resBox.querySelectorAll(".item")].forEach(el=>{
      el.addEventListener("click", ()=>{
        const idx = +el.getAttribute("data-i");
        const m = matches[idx];
        const firmCoord = m.f._coord;
        const cust = ctxCustomer;
        closeCtx();
        showRouteByCoords(cust.name, cust.coord, m.f.firma, firmCoord);
        try{ m.f.marker.openTooltip?.(); }catch(e){}
      });
    });
  }

  function countryCodeFromLandFallback(land){
    const s = lc(land);
    if(!s) return "";
    if(s.includes("germany")||s.includes("deutschland")||s==="de") return "de";
    if(s.includes("austria")||s.includes("√∂sterreich")||s==="at") return "at";
    if(s.includes("switzerland")||s.includes("schweiz")||s==="ch") return "ch";
    if(s.includes("france")||s.includes("frankreich")||s==="fr") return "fr";
    if(s.includes("poland")||s.includes("polen")||s==="pl") return "pl";
    if(s.includes("czech")||s.includes("tschechien")||s==="cz") return "cz";
    if(s.includes("slovakia")||s.includes("slowakei")||s==="sk") return "sk";
    if(s.includes("belgium")||s.includes("belgien")||s==="be") return "be";
    if(s.includes("denmark")||s.includes("d√§nemark")||s==="dk") return "dk";
    if(s.includes("sweden")||s.includes("schweden")||s==="se") return "se";
    if(s.includes("finland")||s.includes("finnland")||s==="fi") return "fi";
    if(s.includes("italy")||s.includes("italien")||s==="it") return "it";
    if(s.includes("estonia")||s.includes("estland")||s==="ee") return "ee";
    if(s.includes("latvia")||s.includes("lettland")||s==="lv") return "lv";
    if(s.includes("lithuania")||s.includes("litauen")||s==="lt") return "lt";
    if(s.includes("netherlands")||s.includes("niederlande")||s==="nl") return "nl";
    if(s.includes("united kingdom")||s.includes("uk")||s.includes("england")||s==="gb") return "gb";
    return "";
  }

  async function buildMap(){
    // alte Marker entfernen
    alleMarker.forEach(m=>{ if(map.hasLayer(m.marker)) map.removeLayer(m.marker); });
    if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
    if(searchMarker){ map.removeLayer(searchMarker); searchMarker=null; }
    closeCtx(); resetMatchHighlights();
    selectedPoints=[];

    alleMarker=[]; const bounds=L.latLngBounds();

    // Firmen
    for(const w of werke){
      const c=geoCache[w.ort]?.country_code?geoCache[w.ort]:await geocode(w.ort); if(!c) continue;
      const farbe=sackAktiv()?w.farbeSack:w.farbeWerk;

      const m=L.circleMarker([c.lat,c.lon],{radius:8,color:farbe,fillColor:farbe,fillOpacity:.85})
        .bindTooltip("",{sticky:true})
        .on("tooltipopen",()=>m.getTooltip().setContent(tooltipFirma({...w,country_code:c.country_code})))
        .on("click",()=>pickPoint(w.firma,{lat:c.lat,lon:c.lon}));

      alleMarker.push({type:"firma",marker:m,...w,country_code:c.country_code||"", _coord:{lat:c.lat,lon:c.lon}});
      bounds.extend([c.lat,c.lon]);
    }

    // Kunden
    for(const k of kunden){
      const c=geoCache[k.ort]?.country_code?geoCache[k.ort]:await geocode(k.ort); if(!c) continue;
      const isSackOnly=(k.sackware==="ja")&&(k.lose!=="ja"), isSonstige=(k.sonstige==="ja");
      const type=isSonstige?"sonstige":isSackOnly?"sackkunde":"kunde";
      const icon=isSonstige?iconOrange:isSackOnly?iconPurple:iconBlue;

      const m=L.marker([c.lat,c.lon],{icon})
        .bindTooltip(`<b>${k.name}</b><br>${k.ort}<br><small>Rechtsklick: Zielpreis-Suche</small>`,{sticky:true})
        .on("click",()=>pickPoint(k.name,{lat:c.lat,lon:c.lon}))
        .on("contextmenu",(e)=>{
          e.originalEvent?.preventDefault?.();
          openCustomerMenu(k,{lat:c.lat,lon:c.lon},e.originalEvent);
        });

      alleMarker.push({type,marker:m,...k,country_code:c.country_code||"", _coord:{lat:c.lat,lon:c.lon}});
      bounds.extend([c.lat,c.lon]);
    }

    if(bounds.isValid()) map.fitBounds(bounds.pad(.15));
    updateLayers();
  }

  function updateLayers(){
    clearRoute();
    closeCtx();
    resetMatchHighlights();
    if(searchMarker){ map.removeLayer(searchMarker); searchMarker=null; }

    const selected=getSelectedCountries(), noCountry=(selected.length===1&&selected[0]==="all");
    const en=chkEnPlus.checked, din=chkDINplus.checked, sure=chkSURE.checked, cpp=chkCPP.checked, ohne=chkOhneZert.checked;
    const gr=chkGruen.checked, or=chkOrange.checked, ro=chkRot.checked, ga=chkGrau.checked;
    const showK=chkKunden.checked, showSK=chkSackKunden.checked, showS=chkSonstigeKunden.checked;

    const wantF=chkSackFireflies.checked, want15=chkSack15kg.checked, useSack=(wantF||want15);

    for(const m of alleMarker){
      if(map.hasLayer(m.marker)) map.removeLayer(m.marker);

      if(!noCountry && (!m.country_code || !selected.includes(m.country_code))) continue;

      if(m.type==="kunde"){ if(showK) map.addLayer(m.marker); continue; }
      if(m.type==="sackkunde"){ if(showSK) map.addLayer(m.marker); continue; }
      if(m.type==="sonstige"){ if(showS) map.addLayer(m.marker); continue; }

      if(useSack){
        const s=lc(m.sack).replace(/\s+/g," ");
        const hasF=s.includes("fireflies"), has15=s.includes("15 kg")||s.includes("15kg");
        if(wantF&&!want15&&!hasF) continue;
        if(want15&&!wantF&&!has15) continue;
        if(wantF&&want15&&!(hasF||has15)) continue;
      }

      const z=lc(m.zert);
      let zertOK=false;
      if(z.includes("enplus")&&en) zertOK=true;
      if(z.includes("dinplus")&&din) zertOK=true;
      if(z.includes("sure")&&sure) zertOK=true;
      if(z.includes("cpp")&&cpp) zertOK=true;
      if(!z&&ohne) zertOK=true;
      if(!zertOK) continue;

      const farbe=useSack?m.farbeSack:m.farbeWerk;
      const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
      if(!ok) continue;

      m.marker.setStyle?.({color:farbe,fillColor:farbe});
      map.addLayer(m.marker);
    }
  }

  // Klick auf Karte -> Route weg (wie bei dir)
  const onMapClick = (e)=>{
    if(ctxEl) return;
    if(routeLine){
      const t = e.originalEvent?.target;
      if(t && (t.tagName==="path" || t.closest?.("path"))) return;
    }
    clearRoute();
  };
  map.on("click", onMapClick);

  const onEsc = (e)=>{ if(e.key==="Escape") clearRoute(); };
  document.addEventListener("keydown", onEsc);

  // Filter change
  const onAnyChange = (e)=>{
    if(e.target?.matches('input[type="checkbox"]') && !e.target.classList.contains("countryChk")){
      updateLayers();
    }
  };
  document.addEventListener("change", onAnyChange);

  // Close ctx when click outside
  const onDown = (e)=>{
    if(!ctxEl) return;
    if(ctxEl.contains(e.target)) return;
    closeCtx();
  };
  document.addEventListener("mousedown", onDown);
  map.on("movestart", closeCtx);
  map.on("zoomstart", closeCtx);

  async function search(query){
    const raw = String(query||"").trim();
    if(!raw) return;

    closeCtx();
    clearRoute();
    if(searchMarker){map.removeLayer(searchMarker);searchMarker=null}

    const q=lc(raw);
    const matches=alleMarker.filter(m=>{
      const name=lc(m.firma||m.name), ort=lc(m.ort);
      return name.includes(q)||ort.includes(q);
    });

    const bounds=L.latLngBounds();
    matches.forEach((m,i)=>{
      if(!map.hasLayer(m.marker)) map.addLayer(m.marker);
      bounds.extend(m.marker.getLatLng());
      if(i===0) m.marker.openTooltip?.();
    });

    const geo=await geocode(raw);
    if(geo){
      const ll=[geo.lat,geo.lon];
      const coordObj = {lat: geo.lat, lon: geo.lon};

      searchMarker=L.circleMarker(ll,{radius:8,color:"blue",fillColor:"blue",fillOpacity:.5}).addTo(map);

      searchMarker.bindPopup(
        `<b>${raw}</b>${geo.country?`<br>${geo.country}`:""}<br><small>Rechtsklick: Zielpreis-Suche</small>`
      );
      searchMarker.bindTooltip(
        `<b>${raw}</b><br><small>Rechtsklick: Zielpreis-Suche</small>`,
        {sticky:true}
      );

      // Klick -> als Punkt f√ºr Route
      searchMarker.on("click",()=>{
        pickPoint(raw, coordObj);
        searchMarker.openPopup();
      });

      // Rechtsklick -> Zielpreis-Men√º
      searchMarker.on("contextmenu",(ev)=>{
        ev.originalEvent?.preventDefault?.();
        openCustomerMenu({ name: raw, ort: geo.country || raw }, coordObj, ev.originalEvent);
      });

      bounds.extend(ll);
    }

    if(bounds.isValid()) map.fitBounds(bounds.pad(.2));
    else alert("Kein Treffer gefunden.");
  }

  return {
    async init(){ await ladeDaten(); await buildMap(); },
    updateLayers,
    search,
    destroy(){
      // Listener sauber entfernen
      map.off("click", onMapClick);
      document.removeEventListener("keydown", onEsc);
      document.removeEventListener("change", onAnyChange);
      document.removeEventListener("mousedown", onDown);

      closeCtx();
      resetMatchHighlights();
      clearRoute();
      if(searchMarker){ map.removeLayer(searchMarker); searchMarker=null; }

      // alle Unit-marker weg
      alleMarker.forEach(m=>{ if(map.hasLayer(m.marker)) map.removeLayer(m.marker); });
      alleMarker=[];
    }
  };
}

/* =========================================================
   S√ÑGERESTHOLZ UNIT (minimal / simple)
   -> wenn du willst, baue ich dir wieder die gro√üe Version rein
========================================================= */
function createSaegerestholzUnit(){
  // Beispiel-Links (falls du sp√§ter willst, trag deine ein)
  const FIRMA_CSV="https://docs.google.com/spreadsheets/d/1GIBV-WAyaslfi175jpbif0bHw8YWAhriifM7CtDUB2k/gviz/tq?tqx=out:csv&gid=0";
  const KUNDEN_CSV="https://docs.google.com/spreadsheets/d/148jjtRze9SmuFsDNRfoM_nwEih7GbCzOjMUQEAb78pg/gviz/tq?tqx=out:csv&gid=0";

  const num=v=>{v=String(v??"").trim().replace(",",".");const n=+v;return isFinite(n)?n:NaN};

  const blauesDreieck = L.divIcon({
    html:`<svg width="24" height="24"><polygon points="12,2 22,22 2,22" fill="blue"/></svg>`,
    iconAnchor:[12,22]
  });

  let markers=[], routeLine=null, pts=[];

  async function loadCSV(url){
    const res=await fetch(url,{cache:"no-store"}); const txt=await res.text();
    return Papa.parse(txt,{header:true,skipEmptyLines:true}).data || [];
  }

  function clearRoute(){
    if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
    pts=[];
    map.closePopup();
  }

  async function init(){
    const [firmen,kunden] = await Promise.all([loadCSV(FIRMA_CSV), loadCSV(KUNDEN_CSV)]);

    // Versuch: lat/lon Spalten (lat/lon oder R/S) ‚Äì falls nicht da, werden Eintr√§ge √ºbersprungen
    const addPoint = (label, ll)=>{
      pts.push({label, ll});
      if(pts.length===2){
        if(routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline([pts[0].ll, pts[1].ll], {color:"blue", weight:5, opacity:.85}).addTo(map);
        map.fitBounds(routeLine.getBounds(), {padding:[40,40]});
        L.popup().setLatLng(routeLine.getBounds().getCenter()).setContent(
          `<b>Route:</b> ${pts[0].label} ‚Üî ${pts[1].label}`
        ).openOn(map);
        pts=[];
      }
    };

    for(const f of firmen){
      const lat = num(f.lat ?? f.Lat ?? f.latitude);
      const lon = num(f.lon ?? f.Lon ?? f.lng ?? f.longitude);
      if(!isFinite(lat)||!isFinite(lon)) continue;

      const m = L.circleMarker([lat,lon],{radius:8,color:"green",fillColor:"green",fillOpacity:.8})
        .addTo(map)
        .bindTooltip(`<b>${f.firma||f.name||"Firma"}</b><br>${f.ort||""}`,{sticky:true})
        .on("click", ()=> addPoint((f.firma||f.name||"Firma"), [lat,lon]));

      markers.push(m);
    }

    for(const k of kunden){
      const lat = num(k.lat ?? k.Lat ?? k.latitude);
      const lon = num(k.lon ?? k.Lon ?? k.lng ?? k.longitude);
      if(!isFinite(lat)||!isFinite(lon)) continue;

      const m = L.marker([lat,lon],{icon:blauesDreieck})
        .addTo(map)
        .bindTooltip(`<b>${k.name||"Kunde"}</b><br>${k.ort||""}`,{sticky:true})
        .on("click", ()=> addPoint((k.name||"Kunde"), [lat,lon]));

      markers.push(m);
    }
  }

  return {
    init,
    async search(q){
      // simple: nur zoomt nicht ‚Äì bleibt minimal
      alert("S√§gerestholz Suche ist aktuell minimal. Wenn du willst, baue ich dir die volle Suche + Filter wieder rein üôÇ");
    },
    updateLayers(){},
    destroy(){
      clearRoute();
      markers.forEach(m=>{ if(map.hasLayer(m)) map.removeLayer(m); });
      markers=[];
    }
  };
}
</script>

</body>
</html>
