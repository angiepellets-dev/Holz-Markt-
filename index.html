<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Europa Preiskarte ‚Äì Pellets / S√§gerestholz / Streusalz</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{height:100%;margin:0}#map{height:100%;width:100%}
.box{position:absolute;background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);font:14px/1.3 system-ui,Arial;z-index:2000}
.search{top:12px;right:12px;width:260px}
.legend{bottom:12px;right:12px;min-width:180px;z-index:3000}
.cert{bottom:12px;left:12px;z-index:2500}
.box input[type="checkbox"]{width:14px;height:14px;margin-right:5px;vertical-align:middle}
.search input,.search select{width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;outline:none;box-sizing:border-box}
.search .row{margin-top:8px}
.cert hr{border:none;height:1px;background:#eee;margin:6px 0}

.dd{position:relative;display:block;width:100%;margin-top:8px}
.ddbtn{width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;padding:4px 6px;text-align:left;cursor:pointer;box-sizing:border-box}
.ddbtn:after{content:"‚ñæ";float:right;opacity:.6}
.ddm{position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.12);z-index:4000;display:none;min-width:160px;max-height:260px;overflow:auto;padding:6px 8px;box-sizing:border-box}
.ddm label{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;margin:0;white-space:nowrap}

/* ===== Rechtsklick-Box (Kundenmen√º) ===== */
.ctxbox{
  position:absolute; z-index:6000;
  background:#fff; border-radius:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  padding:10px; width:280px;
  font:14px/1.25 system-ui, Arial;
  border:1px solid rgba(0,0,0,.10);
}
.ctxbox b{display:block;margin-bottom:6px}
.ctxbox .row{display:flex; gap:8px; margin:8px 0}
.ctxbox select,.ctxbox input{width:100%; padding:7px 8px; border:1px solid #ccc; border-radius:6px; outline:none; box-sizing:border-box;}
.ctxbox .results{margin-top:8px; max-height:240px; overflow:auto; border-top:1px solid #eee; padding-top:8px;}
.ctxbox .item{padding:8px; border:1px solid #eee; border-radius:8px; cursor:pointer; margin:6px 0;}
.ctxbox .item:hover{background:#fafafa}
.ctxbox .small{font-size:12px;opacity:.75}
.ctxbox .pill{display:inline-block; padding:2px 6px; border-radius:999px; background:#f2f2f2; font-size:12px; margin-left:6px;}
.ctxbox .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px; cursor:move; user-select:none}
.ctxbox .xbtn{border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;padding:2px 8px; line-height:1.6;}
.hidden{display:none!important}
</style>
</head>

<body>
<div id="map"></div>

<!-- Suche + L√§nder + Unit -->
<div class="box search">
  <div>üîç <input id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶" disabled></div>

  <b style="display:block;margin-top:8px">Land / L√§nder filtern</b>
  <div class="dd" id="countryDropdown">
    <div class="ddbtn" id="countryDropdownBtn">Alle L√§nder</div>
    <div class="ddm" id="countryDropdownMenu">
      <label><input type="checkbox" class="countryChk" value="all" checked> Alle</label>
      <label><input type="checkbox" class="countryChk" value="be"> Belgien</label>
      <label><input type="checkbox" class="countryChk" value="dk"> D√§nemark</label>
      <label><input type="checkbox" class="countryChk" value="de"> Deutschland</label>
      <label><input type="checkbox" class="countryChk" value="ee"> Estland</label>
      <label><input type="checkbox" class="countryChk" value="fi"> Finnland</label>
      <label><input type="checkbox" class="countryChk" value="fr"> Frankreich</label>
      <label><input type="checkbox" class="countryChk" value="it"> Italien</label>
      <label><input type="checkbox" class="countryChk" value="lv"> Lettland</label>
      <label><input type="checkbox" class="countryChk" value="lt"> Litauen</label>
      <label><input type="checkbox" class="countryChk" value="nl"> Niederlande</label>
      <label><input type="checkbox" class="countryChk" value="at"> √ñsterreich</label>
      <label><input type="checkbox" class="countryChk" value="pl"> Polen</label>
      <label><input type="checkbox" class="countryChk" value="se"> Schweden</label>
      <label><input type="checkbox" class="countryChk" value="ch"> Schweiz</label>
      <label><input type="checkbox" class="countryChk" value="sk"> Slowakei</label>
      <label><input type="checkbox" class="countryChk" value="cz"> Tschechien</label>
      <label><input type="checkbox" class="countryChk" value="gb"> United Kingdom</label>
    </div>
  </div>

  <div class="row">
    <b style="display:block;margin-bottom:6px">Unit</b>
    <select id="unitSelect">
      <option value="" selected>Bitte ausw√§hlen‚Ä¶</option>
      <option value="pellets">Pellets</option>
      <option value="saegerestholz">S√§gerestholz</option>
      <option value="streusalz">Streusalz</option>
    </select>
  </div>
</div>

<!-- Zertifikate / Produkte -->
<div class="box cert" id="certBox">
  <!-- Pellets -->
  <div id="certPellets" class="hidden">
    <b>Zertifikate & Sackware</b><br>
    <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
    <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
    <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
    <label><input type="checkbox" id="chkCPP" checked> CPP</label><br>
    <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>

    <div id="sackSection">
      <hr>
      <b>Sackware</b><br>
      <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
      <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
    </div>
  </div>

  <!-- S√§gerestholz -->
  <div id="certSaegerestholz" class="hidden">
    <b>Zertifikate</b><br>
    <label><input type="checkbox" id="s_chkSURE" checked> SURE</label><br>
    <label><input type="checkbox" id="s_chkPEFC" checked> PEFC</label><br>
    <label><input type="checkbox" id="s_chkOhneZert" checked> Kein Zertifikat</label>
    <hr>
    <b>Produkt</b><br>
    <label><input type="checkbox" id="s_chkHacks" checked> Hackschnitzel</label><br>
    <label><input type="checkbox" id="s_chkSaeg" checked> S√§gesp√§ne</label><br>
    <label><input type="checkbox" id="s_chkSieb" checked> Siebmaterial</label>
  </div>

  <!-- Streusalz -->
  <div id="certStreusalz" class="hidden">
    <b>Zertifikate</b><br>
    <label><input type="checkbox" id="z_chkEnPlus" checked> EnPlus</label><br>
    <label><input type="checkbox" id="z_chkDINplus" checked> DINplus</label><br>
    <label><input type="checkbox" id="z_chkSURE" checked> SURE</label><br>
    <label><input type="checkbox" id="z_chkCPP" checked> CPP</label><br>
    <label><input type="checkbox" id="z_chkOhneZert" checked> Kein Zertifikat</label>
    <div class="small" style="margin-top:6px;opacity:.7">Sackware ist hier aus.</div>
  </div>
</div>

<!-- Farben + Kunden -->
<div class="box legend" id="legendBox">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>

  <div id="kundenFilterPellets" class="hidden">
    <label><input type="checkbox" id="chkKunden" checked> üî∑ Pelleth√§ndler</label><br>
    <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren H√§ndler</label><br>
    <label><input type="checkbox" id="chkSonstigeKunden" checked> üî∂ Sonstige Kunden</label>
  </div>

  <div id="kundenFilterSaegerestholz" class="hidden">
    <label><input type="checkbox" id="chkKundenSaegerestholz" checked> üî∑ Kunden</label>
  </div>

  <div id="kundenFilterStreusalz" class="hidden">
    <label><input type="checkbox" id="chkKundenStreusalz" checked> üë§ Kunden</label>
  </div>
</div>

<script>
/*** ====== SHEETS ====== ***/
const sheetIdFirmen = "1fNUc0LJqBXxJdW1JRDfYxYORMuqeks_bHqp7zUq5Zmk";
const sheetIdKunden = "1fK_rO1b2eI4sOvUKOufVgmd2lQ85KazPf5Kfm4Iia5I";
const STREUSALZ_SHEET_NAME = "streusalz";

const sheetUrlFirmenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/export?format=csv&gid=0`;
const sheetUrlFirmenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;
const sheetUrlKundenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/export?format=csv&gid=0`;
const sheetUrlKundenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;

const sheetUrlFirmenSaegerestholz = "https://docs.google.com/spreadsheets/d/1GIBV-WAyaslfi175jpbif0bHw8YWAhriifM7CtDUB2k/gviz/tq?tqx=out:csv&gid=0";
const sheetUrlKundenSaegerestholz = "https://docs.google.com/spreadsheets/d/148jjtRze9SmuFsDNRfoM_nwEih7GbCzOjMUQEAb78pg/gviz/tq?tqx=out:csv&gid=0";

/*** ====== MAP ====== ***/
const map=L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:4,maxZoom:18,attribution:"&copy; OpenStreetMap"}).addTo(map);

/*** ====== DOM ====== ***/
const unitSelect = document.getElementById("unitSelect");
const searchInput = document.getElementById("searchInput");
const countryDropdown = document.getElementById("countryDropdown");
const countryDropdownBtn = document.getElementById("countryDropdownBtn");
const countryDropdownMenu = document.getElementById("countryDropdownMenu");

const certPellets = document.getElementById("certPellets");
const certSaegerestholz = document.getElementById("certSaegerestholz");
const certStreusalz = document.getElementById("certStreusalz");

const kundenFilterPellets = document.getElementById("kundenFilterPellets");
const kundenFilterSaegerestholz = document.getElementById("kundenFilterSaegerestholz");
const kundenFilterStreusalz = document.getElementById("kundenFilterStreusalz");

// Pellets certs
const chkEnPlus = document.getElementById("chkEnPlus");
const chkDINplus = document.getElementById("chkDINplus");
const chkSURE = document.getElementById("chkSURE");
const chkCPP = document.getElementById("chkCPP");
const chkOhneZert = document.getElementById("chkOhneZert");
const chkSackFireflies = document.getElementById("chkSackFireflies");
const chkSack15kg = document.getElementById("chkSack15kg");

// Streusalz certs
const z_chkEnPlus = document.getElementById("z_chkEnPlus");
const z_chkDINplus = document.getElementById("z_chkDINplus");
const z_chkSURE = document.getElementById("z_chkSURE");
const z_chkCPP = document.getElementById("z_chkCPP");
const z_chkOhneZert = document.getElementById("z_chkOhneZert");

// Saegerestholz filters
const s_chkSURE = document.getElementById("s_chkSURE");
const s_chkPEFC = document.getElementById("s_chkPEFC");
const s_chkOhneZert = document.getElementById("s_chkOhneZert");
const s_chkHacks = document.getElementById("s_chkHacks");
const s_chkSaeg = document.getElementById("s_chkSaeg");
const s_chkSieb = document.getElementById("s_chkSieb");

const chkGruen = document.getElementById("chkGruen");
const chkOrange = document.getElementById("chkOrange");
const chkRot = document.getElementById("chkRot");
const chkGrau = document.getElementById("chkGrau");

const chkKunden = document.getElementById("chkKunden");
const chkSackKunden = document.getElementById("chkSackKunden");
const chkSonstigeKunden = document.getElementById("chkSonstigeKunden");
const chkKundenSaegerestholz = document.getElementById("chkKundenSaegerestholz");
const chkKundenStreusalz = document.getElementById("chkKundenStreusalz");

/*** ====== STATE / HELPERS ====== ***/
let currentUnit = "";

const geoCache=JSON.parse(localStorage.getItem("geoCache_MULTI_EU_v4")||"{}");
const saveGeo=()=>localStorage.setItem("geoCache_MULTI_EU_v4",JSON.stringify(geoCache));

const distCache = new Map();
const rKey = x => Math.round(x * 10000);
function distKey(a,b){ return `${rKey(a.lat)},${rKey(a.lon)}|${rKey(b.lat)},${rKey(b.lon)}`; }

const num=v=>{v=String(v??"").trim().replace(",",".");v=v.replace(/‚Ç¨/g,"").trim();const n=+v;return isFinite(n)?n:NaN};
const lc=s=>String(s??"").toLowerCase().trim();
const str=v=>String(v??"").trim();

function isPellets(){ return currentUnit==="pellets"; }
function isSaegerestholz(){ return currentUnit==="saegerestholz"; }
function isStreusalz(){ return currentUnit==="streusalz"; }
function sackAktiv(){ return isPellets() && (chkSackFireflies.checked || chkSack15kg.checked); }

function colorForPrice(p,kein){
  if(kein||!isFinite(p)||p<=0) return "#9e9e9e";
  if(p<=260) return "green";
  if(p<285) return "orange";
  return "red";
}

function countryCodeFromLand(landRaw){
  const s = String(landRaw||"").toLowerCase().trim();
  if (!s) return "";
  if (s.includes("deutschland") || s==="de") return "de";
  if (s.includes("√∂sterreich") || s.includes("austria") || s==="at") return "at";
  if (s.includes("schweiz") || s.includes("switzerland") || s==="ch") return "ch";
  if (s.includes("frankreich") || s.includes("france") || s==="fr") return "fr";
  if (s.includes("polen") || s.includes("poland") || s==="pl") return "pl";
  if (s.includes("tschechien") || s.includes("czech") || s==="cz") return "cz";
  if (s.includes("slowakei") || s.includes("slovakia") || s==="sk") return "sk";
  if (s.includes("belgien") || s.includes("belgium") || s==="be") return "be";
  if (s.includes("d√§nemark") || s.includes("denmark") || s==="dk") return "dk";
  if (s.includes("schweden") || s.includes("sweden") || s==="se") return "se";
  if (s.includes("finnland") || s.includes("finland") || s==="fi") return "fi";
  if (s.includes("italien") || s.includes("italy") || s==="it") return "it";
  if (s.includes("estland") || s.includes("estonia") || s==="ee") return "ee";
  if (s.includes("lettland") || s.includes("latvia") || s==="lv") return "lv";
  if (s.includes("litauen") || s.includes("lithuania") || s==="lt") return "lt";
  if (s.includes("niederlande") || s.includes("netherlands") || s==="nl") return "nl";
  if (s.includes("united kingdom") || s.includes("uk") || s.includes("england") || s==="gb") return "gb";
  return "";
}

async function geocodeCached(q){
  if(!q) return null;
  if(geoCache[q]?.country_code && isFinite(geoCache[q]?.lat) && isFinite(geoCache[q]?.lon)) return geoCache[q];
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
    const d=await r.json(); if(!d.length) return null;
    const a=d[0].address||{}, o={lat:+d[0].lat,lon:+d[0].lon,country:a.country||"",country_code:(a.country_code||"").toLowerCase()};
    geoCache[q]=o; saveGeo(); return o;
  }catch(e){
    return null;
  }
}

async function osrmTableDistKmFromSourceToMany(source, destCoords){
  if(!destCoords?.length) return [];
  const all = [source, ...destCoords];
  const coordsStr = all.map(p => `${p.lon},${p.lat}`).join(";");
  const destinations = destCoords.map((_,i)=> String(i+1)).join(";");
  const url = `https://router.project-osrm.org/table/v1/driving/${coordsStr}?sources=0&destinations=${destinations}&annotations=distance`;
  try{
    const res = await fetch(url);
    if(!res.ok) return destCoords.map(()=>null);
    const data = await res.json();
    const row = data?.distances?.[0];
    if(!row) return destCoords.map(()=>null);
    return row.map(m => (m==null ? null : m/1000));
  }catch(e){
    return destCoords.map(()=>null);
  }
}

const tri=(fill)=>L.divIcon({
  className:"t",
  html:`<svg width="24" height="24" viewBox="0 0 24 24"><polygon points="12,2 22,22 2,22" fill="${fill}" stroke="black" stroke-width="1"/></svg>`,
  iconAnchor:[12,22],popupAnchor:[0,-20]
});
const iconBlue=tri("blue"), iconPurple=tri("purple"), iconOrange=tri("orange");

/*** ===== Unit States (nur einmal bauen) ===== */
const unitStates = {
  pellets: { built:false, group:L.layerGroup(), markers:[], werke:null, kunden:null },
  saegerestholz: { built:false, group:L.layerGroup(), markers:[], werke:null, kunden:null },
  streusalz: { built:false, group:L.layerGroup(), markers:[], werke:null, kunden:null }
};
let activeGroup = null;
let selectedPoints=[], routeLine=null, searchMarker=null;
let ctxEl=null, ctxCustomer=null;

function closeCtx(){ if(ctxEl){ctxEl.remove(); ctxEl=null;} ctxCustomer=null; }
function stopEvt(el){
  if(!el) return;
  L.DomEvent.disableClickPropagation(el);
  L.DomEvent.disableScrollPropagation(el);
  ["mousedown","click","dblclick","contextmenu"].forEach(ev=>el.addEventListener(ev, e=>e.stopPropagation()));
  el.addEventListener("wheel", e=>e.stopPropagation(), {passive:true});
  el.addEventListener("touchstart", e=>e.stopPropagation(), {passive:true});
}

/*** ‚úÖ DRAGGABLE ctxbox (nur √ºber Topbar) ***/
function makeDraggable(ctxEl){
  const bar = ctxEl.querySelector(".topbar");
  if(!bar) return;

  let dragging = false;
  let startX = 0, startY = 0;
  let startLeft = 0, startTop = 0;

  const cont = map.getContainer();
  const clamp = (n, min, max)=>Math.max(min, Math.min(max, n));

  function onDown(clientX, clientY){
    dragging = true;
    const rect = ctxEl.getBoundingClientRect();
    const contRect = cont.getBoundingClientRect();
    startX = clientX; startY = clientY;
    startLeft = rect.left - contRect.left;
    startTop  = rect.top  - contRect.top;
    document.body.style.userSelect = "none";
  }
  function onMove(clientX, clientY){
    if(!dragging) return;
    const dx = clientX - startX;
    const dy = clientY - startY;
    const w = ctxEl.offsetWidth;
    const h = ctxEl.offsetHeight;
    const newLeft = clamp(startLeft + dx, 6, cont.clientWidth - w - 6);
    const newTop  = clamp(startTop  + dy, 6, cont.clientHeight - h - 6);
    ctxEl.style.left = newLeft + "px";
    ctxEl.style.top  = newTop  + "px";
  }
  function onUp(){
    dragging = false;
    document.body.style.userSelect = "";
  }

  // Maus
  bar.addEventListener("mousedown", (e)=>{
    if(e.target.closest && e.target.closest("#ctxClose")) return;
    e.preventDefault(); e.stopPropagation();
    onDown(e.clientX, e.clientY);

    const mm = (ev)=>onMove(ev.clientX, ev.clientY);
    const mu = ()=>{
      document.removeEventListener("mousemove", mm);
      document.removeEventListener("mouseup", mu);
      onUp();
    };
    document.addEventListener("mousemove", mm);
    document.addEventListener("mouseup", mu);
  });

  // Touch
  bar.addEventListener("touchstart", (e)=>{
    if(e.target.closest && e.target.closest("#ctxClose")) return;
    const t = e.touches?.[0];
    if(!t) return;
    e.preventDefault(); e.stopPropagation();
    onDown(t.clientX, t.clientY);

    const tm = (ev)=>{
      const tt = ev.touches?.[0];
      if(tt) onMove(tt.clientX, tt.clientY);
    };
    const tu = ()=>{
      document.removeEventListener("touchmove", tm);
      document.removeEventListener("touchend", tu);
      onUp();
    };
    document.addEventListener("touchmove", tm, {passive:false});
    document.addEventListener("touchend", tu);
  }, {passive:false});
}

/*** ===== PARSER Pellets/Streu ===== */
function findIndex(headers, cands){
  const hs=headers.map(h=>lc(h));
  const cs=cands.map(c=>lc(c));
  return hs.findIndex(h=>cs.includes(h));
}
function parseFirmenArray(table){
  if(!table || table.length<2) return [];
  const headers=(table[0]||[]).map(x=>str(x));
  const rows=table.slice(1);

  let nameIdx = findIndex(headers, ["firma","name","werk"]); if(nameIdx<0) nameIdx = 0;
  let ortIdx  = findIndex(headers, ["ort","stadt","standort","adresse","location"]); if(ortIdx<0) ortIdx = 1;

  const preisIdx = 2; // Spalte C
  let sackIdx = findIndex(headers, ["sackwarenpreis","sackwarepreis","preis_sack","sackpreis","preis sack"]);
  if(sackIdx<0) sackIdx = 3;

  let zertIdx = findIndex(headers, ["zertifikat","zertifikate","zert","cert"]); if(zertIdx<0) zertIdx = -1;
  let sackTxtIdx = findIndex(headers, ["sackware","sack","bag","bagged"]); if(sackTxtIdx<0) sackTxtIdx = -1;
  let landIdx = findIndex(headers, ["land","country"]); if(landIdx<0) landIdx=-1;

  return rows
    .filter(r=>str(r[nameIdx]) && str(r[ortIdx]))
    .map(r=>{
      const p = num(r[preisIdx]);
      const ps = num(r[sackIdx]);
      const land = landIdx>=0 ? str(r[landIdx]) : "";
      return {
        firma: str(r[nameIdx]),
        ort: str(r[ortIdx]),
        land,
        country_code: countryCodeFromLand(land),
        preis: p, preisSack: ps,
        zert: zertIdx>=0 ? str(r[zertIdx]) : "",
        sack: sackTxtIdx>=0 ? str(r[sackTxtIdx]) : "",
        _preisOrig: p, _preisSackOrig: ps
      };
    });
}
function parseKunden(rows){
  const keys=Object.keys(rows[0]||{}),
    nameKey=(keys.find(k=>["name","kunde","kundenname"].includes(lc(k)))||keys[0]),
    ortKey=(keys.find(k=>["ort","adresse","standort","anschrift","stadt","location"].includes(lc(k)))||keys[1]),
    loseKey=(keys.find(k=>lc(k)==="lose")||"lose"),
    sackKey=(keys.find(k=>lc(k)==="sackware")||"sackware"),
    sonstKey=(keys.find(k=>lc(k)==="sonstige")||"sonstige"),
    landKey=(keys.find(k=>["land","country"].includes(lc(k)))||null);

  return rows.map(x=>({
    name:str(x[nameKey]),
    ort:str(x[ortKey]),
    land: landKey ? str(x[landKey]) : "",
    country_code: countryCodeFromLand(landKey ? str(x[landKey]) : ""),
    lose:lc(x[loseKey]), sackware:lc(x[sackKey]), sonstige:lc(x[sonstKey])
  })).filter(x=>x.name&&x.ort);
}
function normalizePreise(d){
  const w=d.filter(x=>isFinite(x.preis)&&x.preis>0);
  const s=d.filter(x=>isFinite(x.preisSack)&&x.preisSack>0);
  const avgW=w.length?w.reduce((a,b)=>a+b.preis,0)/w.length:0;
  const avgS=s.length?s.reduce((a,b)=>a+b.preisSack,0)/s.length:0;

  return d.map(x=>{
    x.keinPreisWerk = !(isFinite(x._preisOrig) && x._preisOrig>0);
    x.keinPreisSack = !(isFinite(x._preisSackOrig) && x._preisSackOrig>0);
    if(x.keinPreisWerk) x.preis = avgW;
    if(x.keinPreisSack) x.preisSack = avgS;
    x.farbeWerk = colorForPrice(x._preisOrig, x.keinPreisWerk);
    x.farbeSack = colorForPrice(x._preisSackOrig, x.keinPreisSack);
    return x;
  });
}

/*** ===== PARSER S√§gerestholz ===== */
function normProduktName(p){
  const s = lc(p);
  if (s.includes("hackschnitzel")) return "hackschnitzel";
  if (s.includes("s√§gesp√§ne") || s.includes("saegespaene") || s.includes("s√§gespaene") || s.includes("saegesp√§ne")) return "saegespaene";
  if (s.includes("siebmaterial")) return "siebmaterial";
  return "";
}
function parseSaegerestholzFirmen(rows){
  const keys = Object.keys(rows[0]||{});
  const pick = (cands) => keys.find(k=>cands.includes(lc(k)));
  const firmaKey = pick(["firma","name","werk"]) || keys[0];
  const plzKey   = pick(["plz","zip","postcode","postleitzahl"]) || "plz";
  const ortKey   = pick(["ort","stadt","adresse","standort","location"]) || "ort";
  const landKey  = pick(["land","country"]) || "land";

  const zertKeyQ = keys[16];
  const zertKeyFallback = keys.find(k => ["zertifikate","zertifikat","zert","cert"].includes(lc(k)));
  const zertKey = zertKeyQ || zertKeyFallback;

  const produktKeys = keys.filter(k => lc(k).startsWith("produkt"));
  const preisKeys   = keys.filter(k => lc(k).startsWith("preis"));

  return rows.map(x=>{
    const prices = {};
    const pairs = Math.max(produktKeys.length, preisKeys.length);
    for(let i=0;i<pairs;i++){
      const pn = normProduktName(produktKeys[i] ? str(x[produktKeys[i]]) : "");
      const pv = preisKeys[i] ? num(x[preisKeys[i]]) : NaN;
      if(pn){
        if(isFinite(pv) && pv>0) prices[pn]=pv;
        else if(!(pn in prices)) prices[pn]=0;
      }
    }
    const land = str(x[landKey]);
    return {
      firma: str(x[firmaKey]),
      plz: str(x[plzKey]),
      ort: str(x[ortKey]),
      land,
      country_code: countryCodeFromLand(land),
      zert: zertKey ? str(x[zertKey]) : "",
      prices
    };
  }).filter(w=>w.firma && (w.plz || w.ort));
}
function parseSaegerestholzKunden(rows){
  const keys = Object.keys(rows[0]||{});
  const pick = (cands) => keys.find(k=>cands.includes(lc(k)));
  const nameKey = pick(["kunde","name","firma","unternehmen"]) || keys[0];
  const plzKey  = pick(["plz","zip","postcode","postleitzahl"]) || "plz";
  const ortKey  = pick(["ort","stadt","adresse","standort","location"]) || "ort";
  const landKey = pick(["land","country"]) || "land";

  return rows.map(x=>{
    const land = str(x[landKey]);
    return {
      name: str(x[nameKey]),
      plz: str(x[plzKey]),
      ort: str(x[ortKey]),
      land,
      country_code: countryCodeFromLand(land)
    };
  }).filter(k=>k.name && (k.plz || k.ort));
}
function buildQueriesPLZOrtLand(obj){
  const plz=(obj.plz||"").trim();
  const ort=(obj.ort||"").trim();
  const land=(obj.land||"").trim();
  const q1=`${plz} ${ort}, ${land}`.replace(/\s+/g," ").trim();
  const q2=`${plz} ${ort}`.replace(/\s+/g," ").trim();
  const q3=`${ort}, ${land}`.replace(/\s+/g," ").trim();
  const q4=`${ort}`.trim();
  return [q1,q2,q3,q4].filter(Boolean);
}

/*** ===== LOADERS ===== */
async function loadWerkeForUnit(unit){
  if(unit==="saegerestholz"){
    if(unitStates.saegerestholz.werke) return unitStates.saegerestholz.werke;
    const data = await new Promise(res=>Papa.parse(sheetUrlFirmenSaegerestholz,{
      download:true, header:true, skipEmptyLines:true,
      complete:r=>{ try{ res(parseSaegerestholzFirmen(r.data||[])) }catch(e){ res([]) } },
      error:_=>res([])
    }));
    unitStates.saegerestholz.werke = data;
    return data;
  }

  if(unitStates[unit].werke) return unitStates[unit].werke;

  const url = (unit==="pellets") ? sheetUrlFirmenPellets : sheetUrlFirmenStreusalz;
  const data = await new Promise(res=>Papa.parse(url,{
    download:true, header:false, skipEmptyLines:true,
    complete:r=>{ try{ res(normalizePreise(parseFirmenArray(r.data||[]))) }catch(e){ res([]) } },
    error:_=>res([])
  }));
  unitStates[unit].werke = data;
  return data;
}
async function loadKundenForUnit(unit){
  if(unit==="saegerestholz"){
    if(unitStates.saegerestholz.kunden) return unitStates.saegerestholz.kunden;
    const data = await new Promise(res=>Papa.parse(sheetUrlKundenSaegerestholz,{
      download:true, header:true, skipEmptyLines:true,
      complete:r=>{ try{ res(parseSaegerestholzKunden(r.data||[])) }catch(e){ res([]) } },
      error:_=>res([])
    }));
    unitStates.saegerestholz.kunden = data;
    return data;
  }

  if(unitStates[unit].kunden) return unitStates[unit].kunden;

  const url = (unit==="pellets") ? sheetUrlKundenPellets : sheetUrlKundenStreusalz;
  const data = await new Promise(res=>Papa.parse(url,{
    download:true, header:true, skipEmptyLines:true,
    complete:r=>{ try{ res(parseKunden(r.data||[])) }catch(e){ res([]) } },
    error:_=>res([])
  }));
  unitStates[unit].kunden = data;
  return data;
}

/*** ===== Country UI ===== */
function getSelectedCountries(){
  const s=[...document.querySelectorAll(".countryChk")].filter(c=>c.checked).map(c=>c.value);
  return (!s.length||s.includes("all"))?["all"]:s;
}
function updateCountryButtonLabel(){
  const s=getSelectedCountries();
  if(s.length===1&&s[0]==="all") return countryDropdownBtn.textContent="Alle L√§nder";
  const names={be:"BE",dk:"DK",de:"DE",ee:"EE",fi:"FI",fr:"FR",it:"IT",lv:"LV",lt:"LT",nl:"NL",at:"AT",pl:"PL",se:"SE",ch:"CH",sk:"SK",cz:"CZ",gb:"UK"};
  countryDropdownBtn.textContent=s.map(c=>names[c]||c.toUpperCase()).join(", ");
}

/*** ===== Tooltip ===== */
function tooltipFirma(m){
  if(isSaegerestholz()){
    const place = `${m.plz ? m.plz+" " : ""}${m.ort||""}`.trim();
    const z = m.zert ? `<br><b>Zertifikat:</b> ${m.zert}` : "";
    const h = m.prices?.hackschnitzel;
    const s = m.prices?.saegespaene;
    const i = m.prices?.siebmaterial;
    const lineH = (h!==undefined) ? `<b>Hackschnitzel:</b> ${isFinite(h)&&h>0 ? h.toFixed(2)+" ‚Ç¨" : "‚Äì"}` : "";
    const lineS = (s!==undefined) ? `<b>S√§gesp√§ne:</b> ${isFinite(s)&&s>0 ? s.toFixed(2)+" ‚Ç¨" : "‚Äì"}` : "";
    const lineI = (i!==undefined) ? `<b>Siebmaterial:</b> ${isFinite(i)&&i>0 ? i.toFixed(2)+" ‚Ç¨" : "‚Äì"}` : "";
    const lines = [lineH,lineS,lineI].filter(Boolean).join("<br>");
    return `<b>${m.firma}</b><br>${place}${m.land?`<br>${m.land}`:""}${z}${lines?`<br>${lines}`:""}`;
  }

  const useSack = sackAktiv();
  const p = (isPellets() && useSack)
    ? (m.keinPreisSack ? NaN : m._preisSackOrig)
    : (m.keinPreisWerk ? NaN : m._preisOrig);

  const preisTxt = (isFinite(p)&&p>0) ? `${p.toFixed(2)} ‚Ç¨` : "‚Äì";
  const z=m.zert?`<br><b>Zertifikat:</b> ${m.zert}`:"";
  const s=(isPellets() && m.sack)?`<br><b>Sackware:</b> ${m.sack}`:"";
  return `<b>${m.firma}</b><br>${m.ort}${m.land?`<br>${m.land}`:""}<br>${preisTxt}${z}${s}`;
}

/*** ===== S√ÑGERESTHOLZ active price ===== */
function activePriceForSaegerestholzWerk(w){
  const showH = s_chkHacks.checked;
  const showS = s_chkSaeg.checked;
  const showI = s_chkSieb.checked;
  const pH = w.prices?.hackschnitzel;
  const pS = w.prices?.saegespaene;
  const pI = w.prices?.siebmaterial;
  const list = [];
  if(showH && isFinite(pH) && pH>0) list.push(pH);
  if(showS && isFinite(pS) && pS>0) list.push(pS);
  if(showI && isFinite(pI) && pI>0) list.push(pI);
  if(!list.length) return { price: 0, keinPreis:true };
  return { price: Math.min(...list), keinPreis:false };
}

/*** ===== Strecken/Preis ===== */
function luftlinieKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon), la1=toRad(a.lat), la2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}
function calcDeliveredPricePelletsStreu(distKm, basePrice){
  const preisProKm = distKm < 250 ? 2.15 : 1.85;
  const berechnung = (distKm/24) * preisProKm;
  const margeFaktor = (currentUnit === "streusalz") ? 1.20 : 1.05;
  const total = (berechnung + (basePrice||0)) * margeFaktor;
  return { total, preisProKm, margeFaktor };
}

// S√§gerestholz Formeln
const S_MARGE = 1.05;
const HACKS_TEILER = 90, HACKS_KM = 2.15;
const SAEG_TEILER = 90, SAEG_KM = 2.15;
const SIEB_TONNE = 21.50, SIEB_KM_SATZ = 1.85, SIEB_ATRO = 11.8;
function calcHackschnitzel(ek, km){ if(!(isFinite(ek)&&ek>0)) return null; return (ek + ((km * HACKS_KM) / HACKS_TEILER)) * S_MARGE; }
function calcSaegespaene(ek, km){ if(!(isFinite(ek)&&ek>0)) return null; return (ek + ((km * SAEG_KM) / SAEG_TEILER)) * S_MARGE; }
function calcSiebmaterial(ek, km){ if(!(isFinite(ek)&&ek>0)) return null; return (((ek * SIEB_TONNE) + (SIEB_KM_SATZ * km)) / SIEB_ATRO) * S_MARGE; }

/*** ===== ROUTE drawing ===== */
async function showRouteByCoords(aLabel,aCoord,bLabel,bCoord){
  const osrm=`https://router.project-osrm.org/route/v1/driving/${aCoord.lon},${aCoord.lat};${bCoord.lon},${bCoord.lat}?overview=full&geometries=geojson`;
  let distKm=null, coords=null, dashed=false, durStr="";
  try{
    const res=await fetch(osrm);
    const data=res.ok?await res.json():null;
    if(data?.routes?.length){
      const r=data.routes[0];
      distKm=r.distance/1000;
      const min=r.duration/60, h=Math.floor(min/60), m=Math.round(min%60);
      durStr=h?`${h}h ${m}min`:`${m}min`;
      coords=r.geometry.coordinates.map(c=>[c[1],c[0]]);
    }
  }catch(e){}
  if(!distKm){
    distKm=luftlinieKm(aCoord,bCoord);
    coords=[[aCoord.lat,aCoord.lon],[bCoord.lat,bCoord.lon]];
    dashed=true;
  }

  let popupExtra = "";
  const st = unitStates[currentUnit];
  if(isSaegerestholz()){
    const firm = st.werke.find(w=>w.firma===aLabel || w.firma===bLabel);
    const pH = firm?.prices?.hackschnitzel;
    const pS = firm?.prices?.saegespaene;
    const pI = firm?.prices?.siebmaterial;
    const tH = (isFinite(pH)&&pH>0) ? calcHackschnitzel(pH, distKm) : null;
    const tS = (isFinite(pS)&&pS>0) ? calcSaegespaene(pS, distKm) : null;
    const tI = (isFinite(pI)&&pI>0) ? calcSiebmaterial(pI, distKm) : null;
    popupExtra = `
      <hr style="border:none;height:1px;background:#eee;margin:8px 0;">
      <b>Hackschnitzel:</b> ${tH!==null ? `<span style="color:green;font-weight:800">${tH.toFixed(2)} ‚Ç¨</span>`:"‚Äì"}<br>
      <b>S√§gesp√§ne:</b> ${tS!==null ? `<span style="color:green;font-weight:800">${tS.toFixed(2)} ‚Ç¨</span>`:"‚Äì"}<br>
      <b>Siebmaterial:</b> ${tI!==null ? `<span style="color:green;font-weight:800">${tI.toFixed(2)} ‚Ç¨</span>`:"‚Äì"}
    `;
  }else{
    const useSack = sackAktiv();
    const firm = st.werke.find(w=>w.firma===aLabel || w.firma===bLabel);
    const base = firm ? ((isPellets() && useSack) ? firm.preisSack : firm.preis) : 0;
    const {total, preisProKm, margeFaktor} = calcDeliveredPricePelletsStreu(distKm, base);
    const margeTxt = (margeFaktor===1.20) ? "20%" : "5%";
    popupExtra = `
      <b>Preis pro km:</b> ${preisProKm.toFixed(2)} ‚Ç¨<br>
      <b>${(isPellets() && useSack)?"Sackware-Preis":"Werkspreis"}:</b> ${(base||0).toFixed(2)} ‚Ç¨<br>
      <b>Marge:</b> ${margeTxt}<br>
      <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${total.toFixed(2)} ‚Ç¨</span>
    `;
  }

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{color:"blue",weight:5,opacity:.85,dashArray:dashed?"8 8":null}).addTo(map);
  const mid=coords[Math.floor(coords.length/2)];

  L.popup().setLatLng(mid).setContent(`
    <b>Route:</b> ${aLabel} ‚Üî ${bLabel}<br>
    <b>Entfernung:</b> ${distKm.toFixed(1)} km ${dashed?"(Luftlinie)":"(Stra√üe)"}<br>
    ${durStr?`<b>Dauer:</b> ${durStr}<br>`:""}
    ${popupExtra}
    ${dashed?`<br><small>Keine Stra√üenroute verf√ºgbar ‚Üí Luftlinie gestrichelt.</small>`:""}
  `).openOn(map);

  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}

/*** ===== Context Menu / Zielpreis ===== */
function openCustomerMenu(kunde, coord, mouseEvent){
  closeCtx();
  ctxCustomer = {name:kunde.name, ort:kunde.ort, coord};

  const p = map.mouseEventToContainerPoint(mouseEvent);
  const cont = map.getContainer();

  ctxEl = document.createElement("div");
  ctxEl.className = "ctxbox";
  ctxEl.style.left = Math.min(Math.max(10, p.x), cont.clientWidth-300) + "px";
  ctxEl.style.top  = Math.min(Math.max(10, p.y), cont.clientHeight-320) + "px";

  let typeRow = "";
  if(isPellets()){
    typeRow = `<div class="row" style="margin-top:10px">
      <select id="ctxType"><option value="lose">Pellets lose</option><option value="sack">Sackware</option></select>
    </div>`;
  } else if(isSaegerestholz()){
    typeRow = `<div class="row" style="margin-top:10px">
      <select id="ctxType">
        <option value="hackschnitzel">Hackschnitzel</option>
        <option value="saegespaene">S√§gesp√§ne</option>
        <option value="siebmaterial">Siebmaterial</option>
      </select>
    </div>`;
  } else {
    typeRow = `<div class="row" style="margin-top:10px"><div class="small"><b>Unit:</b> Streusalz</div></div>`;
  }

  ctxEl.innerHTML = `
    <div class="topbar">
      <div style="min-width:0">
        <b style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.name}</b>
        <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.ort}</div>
      </div>
      <button class="xbtn" id="ctxClose">√ó</button>
    </div>
    ${typeRow}
    <div class="row"><input id="ctxPrice" type="number" step="0.01" placeholder="Zielpreis (‚Ç¨) eingeben‚Ä¶"></div>
    <div class="results" id="ctxResults"></div>
  `;

  cont.appendChild(ctxEl);
  stopEvt(ctxEl);
  makeDraggable(ctxEl); // ‚úÖ draggable aktivieren

  ctxEl.querySelector("#ctxClose").addEventListener("click", closeCtx);

  const input = ctxEl.querySelector("#ctxPrice");
  input.focus();
  input.addEventListener("keydown", async (e)=>{
    if(e.key !== "Enter") return;
    const target = num(input.value);
    const type = (isPellets() || isSaegerestholz()) ? (ctxEl.querySelector("#ctxType").value) : "streu";
    if(!isFinite(target) || target<=0){ alert("Bitte einen g√ºltigen Zielpreis eingeben."); return; }
    await runTargetSearch(type, target);
  });
}

async function runTargetSearch(type, targetPrice){
  if(!ctxEl || !ctxCustomer) return;
  const resBox = ctxEl.querySelector("#ctxResults");
  resBox.innerHTML = `<div class="small">Suche‚Ä¶</div>`;

  const st = unitStates[currentUnit];
  const visibleFirms = st.markers.filter(m => m.type==="firma" && st.group.hasLayer(m.marker));

  // ‚úÖ Dedup
  const seen = new Set();
  const candidates = [];
  for(const m of visibleFirms){
    let base = null;

    if(isSaegerestholz()){
      base = m.prices?.[type];
      if(!(isFinite(base) && base>0)) continue;
      const key = `${lc(m.firma)}|${lc(m.ort)}|${type}|${base.toFixed(4)}`;
      if(seen.has(key)) continue;
      seen.add(key);
      candidates.push({ ...m, base });
    }else{
      const isSack = isPellets() && (type === "sack");
      const hasReal = isSack ? !m.keinPreisSack : !m.keinPreisWerk;
      if(!hasReal) continue;
      base = isSack ? m._preisSackOrig : m._preisOrig;
      if(!(isFinite(base) && base>0)) continue;
      const key = `${lc(m.firma)}|${lc(m.ort)}|${isSack?"sack":"lose"}|${base.toFixed(4)}`;
      if(seen.has(key)) continue;
      seen.add(key);
      candidates.push({ ...m, base });
    }
  }

  if(!candidates.length){
    resBox.innerHTML = `<div class="small">Keine passenden Werke mit <b>echtem</b> Preis gefunden (Filter beachten).</div>`;
    return;
  }

  const c = ctxCustomer.coord;
  const dests = candidates.map(f => ({ lat: f._coord.lat, lon: f._coord.lon }));
  const dists = await osrmTableDistKmFromSourceToMany({lat:c.lat,lon:c.lon}, dests);

  const matches = [];
  for(let i=0;i<candidates.length;i++){
    const f = candidates[i];
    const a = {lat:c.lat,lon:c.lon};
    const b = {lat:f._coord.lat,lon:f._coord.lon};

    let dist = dists[i];
    if(!dist){
      const key = distKey(a,b);
      if(distCache.has(key)) dist = distCache.get(key);
      else{
        dist = luftlinieKm(a,b);
        distCache.set(key, dist);
      }
    }else{
      distCache.set(distKey(a,b), dist);
    }

    let total = null;
    if(isSaegerestholz()){
      if(type==="hackschnitzel") total = calcHackschnitzel(f.base, dist);
      if(type==="saegespaene") total = calcSaegespaene(f.base, dist);
      if(type==="siebmaterial") total = calcSiebmaterial(f.base, dist);
    }else{
      total = calcDeliveredPricePelletsStreu(dist, f.base).total;
    }

    if(isFinite(total) && total <= targetPrice) matches.push({ f, distKm: dist, total });
  }

  matches.sort((a,b)=>a.total-b.total);
  if(!matches.length){
    resBox.innerHTML = `<div class="small">Keine Firma unter ${targetPrice.toFixed(2)} ‚Ç¨ gefunden.</div>`;
    return;
  }

  let pill = "Streusalz";
  let baseLabel = "Werkspreis";
  if(isPellets()){
    pill = (type==="sack"?"Sackware":"Lose");
    baseLabel = (type==="sack" ? "Sackware-Preis" : "Werkspreis");
  }
  if(isSaegerestholz()){
    pill = (type==="hackschnitzel"?"Hacks":type==="saegespaene"?"S√§gesp√§ne":"Sieb");
    baseLabel = "Werkspreis";
  }

  resBox.innerHTML = matches.slice(0,20).map((m,i)=>`
    <div class="item" data-i="${i}">
      <div><b>${m.f.firma}</b><span class="pill">${pill}</span></div>
      <div class="small">${m.f.ort}${m.f.land?`, ${m.f.land}`:""}</div>
      <div class="small"><b>Entfernung:</b> ${m.distKm.toFixed(1)} km</div>
      <div class="small"><b>${baseLabel}:</b> ${m.f.base.toFixed(2)} ‚Ç¨</div>
      <div><b>Lieferpreis:</b> ${m.total.toFixed(2)} ‚Ç¨</div>
      <div class="small">Klick ‚Üí Route anzeigen</div>
    </div>
  `).join("");

  resBox.querySelectorAll(".item").forEach(el=>{
    el.addEventListener("click", async ()=>{
      const idx = +el.getAttribute("data-i");
      const hit = matches[idx];
      if(!hit) return;
      await showRouteByCoords(
        ctxCustomer.name,
        { lat: ctxCustomer.coord.lat, lon: ctxCustomer.coord.lon },
        hit.f.firma,
        { lat: hit.f._coord.lat, lon: hit.f._coord.lon }
      );
    });
  });
}

/*** ===== Build unit ONCE ===== */
async function buildUnitOnce(unit){
  const st = unitStates[unit];
  if(st.built) return;

  st.werke = await loadWerkeForUnit(unit);
  st.kunden = await loadKundenForUnit(unit);

  st.group.clearLayers();
  st.markers = [];

  const bounds = L.latLngBounds();

  // Firmen
  for(const w of st.werke){
    let c=null;

    if(unit==="saegerestholz"){
      const qs = buildQueriesPLZOrtLand(w);
      for(const q of qs){
        c = await geocodeCached(q);
        if(c) break;
      }
    }else{
      // Pellets/Streu: "ort" geocoden
      c = await geocodeCached(w.ort);
    }
    if(!c) continue;

    let farbe = "green";
    if(unit==="saegerestholz"){
      const ap = activePriceForSaegerestholzWerk(w);
      farbe = colorForPrice(ap.price, ap.keinPreis);
    }else{
      farbe = (unit==="pellets" && sackAktiv()) ? w.farbeSack : w.farbeWerk;
    }

    const cm=L.circleMarker([c.lat,c.lon],{radius:8,color:farbe,fillColor:farbe,fillOpacity:.85})
      .bindTooltip("",{sticky:true})
      .on("tooltipopen",()=>cm.getTooltip().setContent(tooltipFirma({...w,country_code:(w.country_code||c.country_code||"")})))
      .on("click",()=>pickPoint(w.firma,{lat:c.lat,lon:c.lon}));

    st.group.addLayer(cm);
    st.markers.push({type:"firma",marker:cm,...w,country_code:(w.country_code||c.country_code||""), _coord:{lat:c.lat,lon:c.lon}});
    bounds.extend([c.lat,c.lon]);
  }

  // Kunden
  for(const k of st.kunden){
    let c=null;

    if(unit==="saegerestholz"){
      const qs = buildQueriesPLZOrtLand(k);
      for(const q of qs){
        c = await geocodeCached(q);
        if(c) break;
      }
    }else{
      c = await geocodeCached(k.ort);
    }
    if(!c) continue;

    let type="kunde", icon=iconBlue;

    if(unit==="pellets"){
      const isSackOnly=(k.sackware==="ja")&&(k.lose!=="ja");
      const isSonstige=(k.sonstige==="ja");
      type=isSonstige?"sonstige":isSackOnly?"sackkunde":"kunde";
      icon=isSonstige?iconOrange:isSackOnly?iconPurple:iconBlue;
    } else if(unit==="streusalz"){
      type="streukunde"; icon=iconBlue;
    } else if(unit==="saegerestholz"){
      type="saegKunde"; icon=iconBlue;
    }

    const name = k.name || "Kunde";
    const ortText = (unit==="saegerestholz")
      ? `${k.plz ? k.plz+" " : ""}${k.ort||""}`.trim()
      : (k.ort||"");

    const mk=L.marker([c.lat,c.lon],{icon})
      .bindTooltip(`<b>${name}</b><br>${ortText}<br><small>Rechtsklick: Zielpreis-Suche</small>`,{sticky:true})
      .on("click",()=>pickPoint(name,{lat:c.lat,lon:c.lon}))
      .on("contextmenu",(e)=>{
        e.originalEvent?.preventDefault?.();
        openCustomerMenu({ name, ort: ortText }, {lat:c.lat,lon:c.lon}, e.originalEvent);
      });

    st.group.addLayer(mk);
    st.markers.push({type,marker:mk,...k,name,ort: ortText,country_code:(k.country_code||c.country_code||""), _coord:{lat:c.lat,lon:c.lon}});
    bounds.extend([c.lat,c.lon]);
  }

  st.built = true;
  st._bounds = bounds.isValid() ? bounds : null;
}

/*** ===== Layers (nur aktive group) ===== */
function updateLayers(){
  if(!currentUnit) return;

  if(routeLine){map.removeLayer(routeLine);routeLine=null}
  map.closePopup(); selectedPoints=[];
  if(searchMarker){map.removeLayer(searchMarker);searchMarker=null}

  const st = unitStates[currentUnit];
  if(!st?.built) return;

  const selected=getSelectedCountries(), noCountry=(selected.length===1&&selected[0]==="all");
  const gr=chkGruen.checked, or=chkOrange.checked, ro=chkRot.checked, ga=chkGrau.checked;

  st.group.clearLayers();

  for(const m of st.markers){
    if(!noCountry && (!m.country_code || !selected.includes(m.country_code))) continue;

    // Kunden
    if(isPellets()){
      if(m.type==="kunde"){ if(chkKunden.checked) st.group.addLayer(m.marker); continue; }
      if(m.type==="sackkunde"){ if(chkSackKunden.checked) st.group.addLayer(m.marker); continue; }
      if(m.type==="sonstige"){ if(chkSonstigeKunden.checked) st.group.addLayer(m.marker); continue; }
    }
    if(isStreusalz()){
      if(m.type==="streukunde"){ if(chkKundenStreusalz.checked) st.group.addLayer(m.marker); continue; }
    }
    if(isSaegerestholz()){
      if(m.type==="saegKunde"){ if(chkKundenSaegerestholz.checked) st.group.addLayer(m.marker); continue; }
    }

    if(m.type!=="firma") continue;

    // Firmen
    if(isPellets()){
      const z=lc(m.zert);
      let zertOK=false;
      if(z.includes("enplus")&&chkEnPlus.checked) zertOK=true;
      if(z.includes("dinplus")&&chkDINplus.checked) zertOK=true;
      if(z.includes("sure")&&chkSURE.checked) zertOK=true;
      if(z.includes("cpp")&&chkCPP.checked) zertOK=true;
      if(!z&&chkOhneZert.checked) zertOK=true;
      if(!zertOK) continue;

      const wantF = chkSackFireflies.checked;
      const want15 = chkSack15kg.checked;
      const useSack = (wantF || want15);
      if(useSack){
        const s=lc(m.sack).replace(/\s+/g," ");
        const hasF=s.includes("fireflies"), has15=s.includes("15 kg")||s.includes("15kg");
        if(wantF && !want15 && !hasF) continue;
        if(want15 && !wantF && !has15) continue;
        if(wantF && want15 && !(hasF||has15)) continue;
      }

      const farbe = useSack ? m.farbeSack : m.farbeWerk;
      const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
      if(!ok) continue;

      m.marker.setStyle?.({color:farbe,fillColor:farbe});
      st.group.addLayer(m.marker);
      continue;
    }

    if(isStreusalz()){
      const z=lc(m.zert);
      let zertOK=false;
      if(z.includes("enplus")&&z_chkEnPlus.checked) zertOK=true;
      if(z.includes("dinplus")&&z_chkDINplus.checked) zertOK=true;
      if(z.includes("sure")&&z_chkSURE.checked) zertOK=true;
      if(z.includes("cpp")&&z_chkCPP.checked) zertOK=true;
      if(!z&&z_chkOhneZert.checked) zertOK=true;
      if(!zertOK) continue;

      const farbe = m.farbeWerk;
      const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
      if(!ok) continue;

      m.marker.setStyle?.({color:farbe,fillColor:farbe});
      st.group.addLayer(m.marker);
      continue;
    }

    if(isSaegerestholz()){
      if(!s_chkHacks.checked && !s_chkSaeg.checked && !s_chkSieb.checked) continue;

      const z=lc(m.zert);
      let zertOK=false;
      if(z.includes("sure") && s_chkSURE.checked) zertOK=true;
      if(z.includes("pefc") && s_chkPEFC.checked) zertOK=true;
      if(!z && s_chkOhneZert.checked) zertOK=true;
      if(!zertOK) continue;

      const ap = activePriceForSaegerestholzWerk(m);
      const farbe = colorForPrice(ap.price, ap.keinPreis);
      const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
      if(!ok) continue;

      m.marker.setStyle?.({color:farbe,fillColor:farbe});
      st.group.addLayer(m.marker);
      continue;
    }
  }
}

/*** ===== Pick / Clear ===== */
function pickPoint(label,coord){
  selectedPoints.push({label,coord});
  if(selectedPoints.length===2){
    const [a,b]=selectedPoints;
    selectedPoints=[];
    showRouteByCoords(a.label,a.coord,b.label,b.coord);
  }
}
function clearRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
  map.closePopup();
  selectedPoints = [];
}

/*** ===== Unit UI ===== */
function applyUnitUIOnly(){
  certPellets.classList.toggle("hidden", !isPellets());
  certSaegerestholz.classList.toggle("hidden", !isSaegerestholz());
  certStreusalz.classList.toggle("hidden", !isStreusalz());

  kundenFilterPellets.classList.toggle("hidden", !isPellets());
  kundenFilterSaegerestholz.classList.toggle("hidden", !isSaegerestholz());
  kundenFilterStreusalz.classList.toggle("hidden", !isStreusalz());

  if(!isPellets()){
    chkSackFireflies.checked = false;
    chkSack15kg.checked = false;
  }
}

/*** ===== Switch Unit ===== */
async function setUnit(newUnit){
  closeCtx();
  clearRoute();

  if(activeGroup){ map.removeLayer(activeGroup); activeGroup = null; }

  currentUnit = newUnit || "";
  searchInput.disabled = !currentUnit;

  if(!currentUnit){
    certPellets.classList.add("hidden");
    certSaegerestholz.classList.add("hidden");
    certStreusalz.classList.add("hidden");
    kundenFilterPellets.classList.add("hidden");
    kundenFilterSaegerestholz.classList.add("hidden");
    kundenFilterStreusalz.classList.add("hidden");
    return;
  }

  applyUnitUIOnly();
  await buildUnitOnce(currentUnit);

  activeGroup = unitStates[currentUnit].group;
  map.addLayer(activeGroup);

  updateLayers();

  const st = unitStates[currentUnit];
  if(st && !st._boundsApplied && st._bounds && st._bounds.isValid()){
    map.fitBounds(st._bounds.pad(0.15));
    st._boundsApplied = true;
  }
}

/*** ===== EVENTS ===== */
unitSelect.addEventListener("change", async ()=>{ await setUnit(unitSelect.value); });

map.on("click", (e)=>{
  if(ctxEl) return;
  if(routeLine){
    const t = e.originalEvent?.target;
    if(t && (t.tagName === "path" || t.closest?.("path"))) return;
  }
  clearRoute();
});
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") clearRoute(); });

/* ‚ùå KEIN "nebenklicken = schlie√üen" mehr!  (Nur X schlie√üt) */
/* ‚úÖ Box bleibt beim Zoomen/Bewegen stehen (kein closeCtx bei move/zoom) */

document.addEventListener("change",e=>{
  if(e.target?.matches('input[type="checkbox"]')){
    if(e.target.classList.contains("countryChk")){
      if(e.target.value==="all"&&e.target.checked) [...document.querySelectorAll(".countryChk")].forEach(x=>x.value!=="all"&&(x.checked=false));
      if(e.target.value!=="all"&&e.target.checked) document.querySelector('.countryChk[value="all"]').checked=false;
      updateCountryButtonLabel();
    }
    updateLayers();
  }
});

countryDropdownBtn.addEventListener("click",()=>countryDropdownMenu.style.display=(countryDropdownMenu.style.display==="block"?"none":"block"));
document.addEventListener("click",e=>{if(!countryDropdown.contains(e.target)) countryDropdownMenu.style.display="none"});

/*** ===== SEARCH ===== */
searchInput.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;
  const raw=e.target.value.trim(); if(!raw) return;
  if(!currentUnit) return;

  closeCtx();
  clearRoute();

  const st = unitStates[currentUnit];

  const q=lc(raw);
  const matches=st.markers.filter(m=>{
    const name=lc(m.firma||m.name||""), ort=lc(m.ort||""), land=lc(m.land||"");
    return name.includes(q)||ort.includes(q)||land.includes(q);
  });

  const bounds=L.latLngBounds();
  matches.forEach((m,i)=>{
    if(!st.group.hasLayer(m.marker)) st.group.addLayer(m.marker);
    bounds.extend(m.marker.getLatLng());
    if(i===0) m.marker.openTooltip?.();
  });

  const geo=await geocodeCached(raw);
  if(geo){
    const ll=[geo.lat,geo.lon];
    const coordObj = {lat: geo.lat, lon: geo.lon};

    if(searchMarker){ try{ map.removeLayer(searchMarker); }catch(err){} }
    searchMarker=L.circleMarker(ll,{radius:8,color:"blue",fillColor:"blue",fillOpacity:.5}).addTo(map);
    searchMarker.bindTooltip(`<b>${raw}</b><br><small>Rechtsklick: Zielpreis-Suche</small>`,{sticky:true});
    searchMarker.on("contextmenu",(ev)=>{
      ev.originalEvent?.preventDefault?.();
      openCustomerMenu({ name: raw, ort: geo.country || raw }, coordObj, ev.originalEvent);
    });

    bounds.extend(ll);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(.2));
  else alert("Kein Treffer gefunden.");
});

/*** ===== INIT ===== */
(async()=>{
  updateCountryButtonLabel();
  await setUnit(""); // Start ohne Unit
})();
</script>
</body>
</html>
