<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Europa Preiskarte ‚Äì Pellets / S√§gerestholz / Streusalz</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{height:100%;margin:0}#map{height:100%;width:100%}
.box{position:absolute;background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);font:14px/1.3 system-ui,Arial;z-index:2000}
.search{top:12px;right:12px;width:260px}
.legend{bottom:12px;right:12px;min-width:180px;z-index:3000}
.cert{bottom:12px;left:12px;z-index:2500}
.box input[type="checkbox"]{width:14px;height:14px;margin-right:5px;vertical-align:middle}
.search input,.search select{width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;outline:none;box-sizing:border-box}
.search .row{margin-top:8px}
.cert hr{border:none;height:1px;background:#eee;margin:6px 0}

.dd{position:relative;display:block;width:100%;margin-top:8px}
.ddbtn{width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;padding:4px 6px;text-align:left;cursor:pointer;box-sizing:border-box}
.ddbtn:after{content:"‚ñæ";float:right;opacity:.6}
.ddm{position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.12);z-index:4000;display:none;min-width:160px;max-height:260px;overflow:auto;padding:6px 8px;box-sizing:border-box}
.ddm label{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;margin:0;white-space:nowrap}

/* ===== Rechtsklick-Box (Kundenmen√º) ===== */
.ctxbox{
  position:absolute; z-index:6000;
  background:#fff; border-radius:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  padding:10px; width:280px;
  font:14px/1.25 system-ui, Arial;
  border:1px solid rgba(0,0,0,.10);
}
.ctxbox b{display:block;margin-bottom:6px}
.ctxbox .row{display:flex; gap:8px; margin:8px 0}
.ctxbox select,.ctxbox input{width:100%; padding:7px 8px; border:1px solid #ccc; border-radius:6px; outline:none; box-sizing:border-box;}
.ctxbox .results{margin-top:8px; max-height:240px; overflow:auto; border-top:1px solid #eee; padding-top:8px;}
.ctxbox .item{padding:8px; border:1px solid #eee; border-radius:8px; cursor:pointer; margin:6px 0;}
.ctxbox .item:hover{background:#fafafa}
.ctxbox .small{font-size:12px;opacity:.75}
.ctxbox .pill{display:inline-block; padding:2px 6px; border-radius:999px; background:#f2f2f2; font-size:12px; margin-left:6px;}
.ctxbox .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
.ctxbox .xbtn{border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;padding:2px 8px; line-height:1.6;}
.hidden{display:none!important}
</style>
</head>

<body>
<div id="map"></div>

<!-- Suche + L√§nder + Unit -->
<div class="box search">
  <div>üîç <input id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶"></div>

  <b style="display:block;margin-top:8px">Land / L√§nder filtern</b>
  <div class="dd" id="countryDropdown">
    <div class="ddbtn" id="countryDropdownBtn">Alle L√§nder</div>
    <div class="ddm" id="countryDropdownMenu">
      <label><input type="checkbox" class="countryChk" value="all" checked> Alle</label>
      <label><input type="checkbox" class="countryChk" value="be"> Belgien</label>
      <label><input type="checkbox" class="countryChk" value="dk"> D√§nemark</label>
      <label><input type="checkbox" class="countryChk" value="de"> Deutschland</label>
      <label><input type="checkbox" class="countryChk" value="ee"> Estland</label>
      <label><input type="checkbox" class="countryChk" value="fi"> Finnland</label>
      <label><input type="checkbox" class="countryChk" value="fr"> Frankreich</label>
      <label><input type="checkbox" class="countryChk" value="it"> Italien</label>
      <label><input type="checkbox" class="countryChk" value="lv"> Lettland</label>
      <label><input type="checkbox" class="countryChk" value="lt"> Litauen</label>
      <label><input type="checkbox" class="countryChk" value="nl"> Niederlande</label>
      <label><input type="checkbox" class="countryChk" value="at"> √ñsterreich</label>
      <label><input type="checkbox" class="countryChk" value="pl"> Polen</label>
      <label><input type="checkbox" class="countryChk" value="se"> Schweden</label>
      <label><input type="checkbox" class="countryChk" value="ch"> Schweiz</label>
      <label><input type="checkbox" class="countryChk" value="sk"> Slowakei</label>
      <label><input type="checkbox" class="countryChk" value="cz"> Tschechien</label>
      <label><input type="checkbox" class="countryChk" value="gb"> United Kingdom</label>
    </div>
  </div>

  <div class="row">
    <b style="display:block;margin-bottom:6px">Unit</b>
    <select id="unitSelect">
      <option value="pellets" selected>Pellets</option>
      <option value="saegerestholz">S√§gerestholz</option>
      <option value="streusalz">Streusalz</option>
    </select>
  </div>
</div>

<!-- Zertifikate / Produkte -->
<div class="box cert" id="certBox">
  <!-- Pellets -->
  <div id="certPellets">
    <b>Zertifikate & Sackware</b><br>
    <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
    <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
    <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
    <label><input type="checkbox" id="chkCPP" checked> CPP</label><br>
    <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>

    <div id="sackSection">
      <hr>
      <b>Sackware</b><br>
      <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
      <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
    </div>
  </div>

  <!-- S√§gerestholz -->
  <div id="certSaegerestholz" class="hidden">
    <b>Zertifikate</b><br>
    <label><input type="checkbox" id="s_chkSURE" checked> SURE</label><br>
    <label><input type="checkbox" id="s_chkPEFC" checked> PEFC</label><br>
    <label><input type="checkbox" id="s_chkOhneZert" checked> Kein Zertifikat</label>
    <hr>
    <b>Produkt</b><br>
    <label><input type="checkbox" id="s_chkHacks" checked> Hackschnitzel</label><br>
    <label><input type="checkbox" id="s_chkSaeg" checked> S√§gesp√§ne</label><br>
    <label><input type="checkbox" id="s_chkSieb" checked> Siebmaterial</label>
  </div>

  <!-- Streusalz -->
  <div id="certStreusalz" class="hidden">
    <b>Zertifikate</b><br>
    <label><input type="checkbox" id="z_chkEnPlus" checked> EnPlus</label><br>
    <label><input type="checkbox" id="z_chkDINplus" checked> DINplus</label><br>
    <label><input type="checkbox" id="z_chkSURE" checked> SURE</label><br>
    <label><input type="checkbox" id="z_chkCPP" checked> CPP</label><br>
    <label><input type="checkbox" id="z_chkOhneZert" checked> Kein Zertifikat</label>
    <div class="small" style="margin-top:6px;opacity:.7">Sackware ist hier aus.</div>
  </div>
</div>

<!-- Farben + Kunden -->
<div class="box legend" id="legendBox">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>

  <!-- Pellets: Typen -->
  <div id="kundenFilterPellets">
    <label><input type="checkbox" id="chkKunden" checked> üî∑ Pelleth√§ndler</label><br>
    <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren H√§ndler</label><br>
    <label><input type="checkbox" id="chkSonstigeKunden" checked> üî∂ Sonstige Kunden</label>
  </div>

  <!-- S√§gerestholz -->
  <div id="kundenFilterSaegerestholz" class="hidden">
    <label><input type="checkbox" id="chkKundenSaegerestholz" checked> üî∑ Kunden</label>
  </div>

  <!-- Streusalz -->
  <div id="kundenFilterStreusalz" class="hidden">
    <label><input type="checkbox" id="chkKundenStreusalz" checked> üë§ Kunden</label>
  </div>
</div>

<script>
/*** ====== SHEETS ====== ***/
// Pellets/Streusalz (deine IDs)
const sheetIdFirmen = "1fNUc0LJqBXxJdW1JRDfYxYORMuqeks_bHqp7zUq5Zmk";
const sheetIdKunden = "1fK_rO1b2eI4sOvUKOufVgmd2lQ85KazPf5Kfm4Iia5I";
const STREUSALZ_SHEET_NAME = "streusalz";

const sheetUrlFirmenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/export?format=csv&gid=0`;
const sheetUrlFirmenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;
const sheetUrlKundenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/export?format=csv&gid=0`;
const sheetUrlKundenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;

// S√§gerestholz (wie vorher)
const sheetUrlFirmenSaegerestholz = "https://docs.google.com/spreadsheets/d/1GIBV-WAyaslfi175jpbif0bHw8YWAhriifM7CtDUB2k/gviz/tq?tqx=out:csv&gid=0";
const sheetUrlKundenSaegerestholz = "https://docs.google.com/spreadsheets/d/148jjtRze9SmuFsDNRfoM_nwEih7GbCzOjMUQEAb78pg/gviz/tq?tqx=out:csv&gid=0";

/*** ====== MAP ====== ***/
const map=L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:4,maxZoom:18,attribution:"&copy; OpenStreetMap"}).addTo(map);

/*** ====== DOM ====== ***/
const unitSelect = document.getElementById("unitSelect");
const searchInput = document.getElementById("searchInput");

const countryDropdown = document.getElementById("countryDropdown");
const countryDropdownBtn = document.getElementById("countryDropdownBtn");
const countryDropdownMenu = document.getElementById("countryDropdownMenu");

// UI sections
const certPellets = document.getElementById("certPellets");
const certSaegerestholz = document.getElementById("certSaegerestholz");
const certStreusalz = document.getElementById("certStreusalz");

const kundenFilterPellets = document.getElementById("kundenFilterPellets");
const kundenFilterSaegerestholz = document.getElementById("kundenFilterSaegerestholz");
const kundenFilterStreusalz = document.getElementById("kundenFilterStreusalz");

// Pellets certs
const chkEnPlus = document.getElementById("chkEnPlus");
const chkDINplus = document.getElementById("chkDINplus");
const chkSURE = document.getElementById("chkSURE");
const chkCPP = document.getElementById("chkCPP");
const chkOhneZert = document.getElementById("chkOhneZert");
const chkSackFireflies = document.getElementById("chkSackFireflies");
const chkSack15kg = document.getElementById("chkSack15kg");

// Streusalz certs (eigene IDs)
const z_chkEnPlus = document.getElementById("z_chkEnPlus");
const z_chkDINplus = document.getElementById("z_chkDINplus");
const z_chkSURE = document.getElementById("z_chkSURE");
const z_chkCPP = document.getElementById("z_chkCPP");
const z_chkOhneZert = document.getElementById("z_chkOhneZert");

// Saegerestholz filters
const s_chkSURE = document.getElementById("s_chkSURE");
const s_chkPEFC = document.getElementById("s_chkPEFC");
const s_chkOhneZert = document.getElementById("s_chkOhneZert");
const s_chkHacks = document.getElementById("s_chkHacks");
const s_chkSaeg = document.getElementById("s_chkSaeg");
const s_chkSieb = document.getElementById("s_chkSieb");

const chkGruen = document.getElementById("chkGruen");
const chkOrange = document.getElementById("chkOrange");
const chkRot = document.getElementById("chkRot");
const chkGrau = document.getElementById("chkGrau");

const chkKunden = document.getElementById("chkKunden");
const chkSackKunden = document.getElementById("chkSackKunden");
const chkSonstigeKunden = document.getElementById("chkSonstigeKunden");
const chkKundenSaegerestholz = document.getElementById("chkKundenSaegerestholz");
const chkKundenStreusalz = document.getElementById("chkKundenStreusalz");

/*** ====== STATE / HELPERS ====== ***/
let currentUnit = unitSelect.value;

// ‚úÖ Cache + schnell laden
const geoCache=JSON.parse(localStorage.getItem("geoCache_MULTI_EU_v2")||"{}");
const saveGeo=()=>localStorage.setItem("geoCache_MULTI_EU_v2",JSON.stringify(geoCache));

let buildToken = 0;

const num=v=>{v=String(v??"").trim().replace(",",".");v=v.replace(/‚Ç¨/g,"").trim();const n=+v;return isFinite(n)?n:NaN};
const lc=s=>String(s??"").toLowerCase().trim();
const str=v=>String(v??"").trim();

function isPellets(){ return currentUnit==="pellets"; }
function isSaegerestholz(){ return currentUnit==="saegerestholz"; }
function isStreusalz(){ return currentUnit==="streusalz"; }

function sackAktiv(){ return isPellets() && (chkSackFireflies.checked || chkSack15kg.checked); }

function colorForPrice(p,kein){
  if(kein||!isFinite(p)||p<=0) return "#9e9e9e";
  if(p<=260) return "green";
  if(p<285) return "orange";
  return "red";
}

// L√§ndername -> country_code (f√ºr Filter ohne Reverse)
function countryCodeFromLand(landRaw){
  const s = String(landRaw||"").toLowerCase().trim();
  if (!s) return "";
  if (s.includes("deutschland") || s==="de") return "de";
  if (s.includes("√∂sterreich") || s.includes("austria") || s==="at") return "at";
  if (s.includes("schweiz") || s.includes("switzerland") || s==="ch") return "ch";
  if (s.includes("frankreich") || s.includes("france") || s==="fr") return "fr";
  if (s.includes("polen") || s.includes("poland") || s==="pl") return "pl";
  if (s.includes("tschechien") || s.includes("czech") || s==="cz") return "cz";
  if (s.includes("slowakei") || s.includes("slovakia") || s==="sk") return "sk";
  if (s.includes("belgien") || s.includes("belgium") || s==="be") return "be";
  if (s.includes("d√§nemark") || s.includes("denmark") || s==="dk") return "dk";
  if (s.includes("schweden") || s.includes("sweden") || s==="se") return "se";
  if (s.includes("finnland") || s.includes("finland") || s==="fi") return "fi";
  if (s.includes("italien") || s.includes("italy") || s==="it") return "it";
  if (s.includes("estland") || s.includes("estonia") || s==="ee") return "ee";
  if (s.includes("lettland") || s.includes("latvia") || s==="lv") return "lv";
  if (s.includes("litauen") || s.includes("lithuania") || s==="lt") return "lt";
  if (s.includes("niederlande") || s.includes("netherlands") || s==="nl") return "nl";
  if (s.includes("united kingdom") || s.includes("uk") || s.includes("england") || s==="gb") return "gb";
  return "";
}

// ‚úÖ Geocode mit Cache (schnell!)
async function geocodeCached(q){
  if(!q) return null;
  if(geoCache[q]?.country_code) return geoCache[q];

  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d=await r.json(); if(!d.length) return null;
  const a=d[0].address||{}, o={lat:+d[0].lat,lon:+d[0].lon,country:a.country||"",country_code:(a.country_code||"").toLowerCase()};
  geoCache[q]=o; saveGeo(); return o;
}

const tri=(fill)=>L.divIcon({
  className:"t",
  html:`<svg width="24" height="24" viewBox="0 0 24 24"><polygon points="12,2 22,22 2,22" fill="${fill}" stroke="black" stroke-width="1"/></svg>`,
  iconAnchor:[12,22],popupAnchor:[0,-20]
});
const iconBlue=tri("blue"), iconPurple=tri("purple"), iconOrange=tri("orange");

/*** ====== DATA CACHES ====== ***/
let werkePellets=null, werkeStreusalz=null, werkeSaegerestholz=null, werke=[];
let kundenPellets=null, kundenStreusalz=null, kundenSaegerestholz=null, kunden=[];

let alleMarker=[], selectedPoints=[], routeLine=null, searchMarker=null;
let ctxEl=null, ctxCustomer=null, matchMarkers=[];
let lastMatches = [];

function closeCtx(){ if(ctxEl){ctxEl.remove(); ctxEl=null;} ctxCustomer=null; lastMatches=[]; }
function resetMatchHighlights(){
  for(const m of matchMarkers){
    try{ if(m.marker.setStyle && m._origStyle) m.marker.setStyle(m._origStyle); }catch(e){}
  }
  matchMarkers=[];
}
function stopEvt(el){
  if(!el) return;
  L.DomEvent.disableClickPropagation(el);
  L.DomEvent.disableScrollPropagation(el);
  el.addEventListener("mousedown", e=>e.stopPropagation());
  el.addEventListener("click", e=>e.stopPropagation());
  el.addEventListener("dblclick", e=>e.stopPropagation());
  el.addEventListener("contextmenu", e=>e.stopPropagation());
  el.addEventListener("wheel", e=>e.stopPropagation(), {passive:true});
  el.addEventListener("touchstart", e=>e.stopPropagation(), {passive:true});
}

/*** ====== PARSER (Pellets/Streusalz) ====== ***/
function findIndex(headers, cands){
  const hs=headers.map(h=>lc(h));
  const cs=cands.map(c=>lc(c));
  return hs.findIndex(h=>cs.includes(h));
}

function parseFirmenArray(table){
  if(!table || table.length<2) return [];
  const headers=(table[0]||[]).map(x=>str(x));
  const rows=table.slice(1);

  let nameIdx = findIndex(headers, ["firma","name","werk"]); if(nameIdx<0) nameIdx = 0;
  let ortIdx  = findIndex(headers, ["ort","stadt","standort","adresse","location"]); if(ortIdx<0) ortIdx = 1;

  const preisIdx = 2; // Spalte C
  let sackIdx = findIndex(headers, ["sackwarenpreis","sackwarepreis","preis_sack","sackpreis","preis sack"]);
  if(sackIdx<0) sackIdx = 3;

  let zertIdx = findIndex(headers, ["zertifikat","zertifikate","zert","cert"]); if(zertIdx<0) zertIdx = -1;
  let sackTxtIdx = findIndex(headers, ["sackware","sack","bag","bagged"]); if(sackTxtIdx<0) sackTxtIdx = -1;

  // optional: Land, falls vorhanden
  let landIdx = findIndex(headers, ["land","country"]); if(landIdx<0) landIdx=-1;

  return rows
    .filter(r=>str(r[nameIdx]) && str(r[ortIdx]))
    .map(r=>{
      const p = num(r[preisIdx]);
      const ps = num(r[sackIdx]);
      const land = landIdx>=0 ? str(r[landIdx]) : "";
      return {
        firma: str(r[nameIdx]),
        ort: str(r[ortIdx]),
        land,
        preis: p,
        preisSack: ps,
        zert: zertIdx>=0 ? str(r[zertIdx]) : "",
        sack: sackTxtIdx>=0 ? str(r[sackTxtIdx]) : "",
        _preisOrig: p,
        _preisSackOrig: ps
      };
    });
}

function parseKunden(rows){
  const keys=Object.keys(rows[0]||{}),
    nameKey=(keys.find(k=>["name","kunde","kundenname"].includes(lc(k)))||keys[0]),
    ortKey=(keys.find(k=>["ort","adresse","standort","anschrift","stadt","location"].includes(lc(k)))||keys[1]),
    loseKey=(keys.find(k=>lc(k)==="lose")||"lose"),
    sackKey=(keys.find(k=>lc(k)==="sackware")||"sackware"),
    sonstKey=(keys.find(k=>lc(k)==="sonstige")||"sonstige"),
    landKey=(keys.find(k=>["land","country"].includes(lc(k)))||null);

  return rows.map(x=>({
    name:str(x[nameKey]),
    ort:str(x[ortKey]),
    land: landKey ? str(x[landKey]) : "",
    lose:lc(x[loseKey]),
    sackware:lc(x[sackKey]),
    sonstige:lc(x[sonstKey])
  })).filter(x=>x.name&&x.ort);
}

function normalizePreise(d){
  const w=d.filter(x=>isFinite(x.preis)&&x.preis>0);
  const s=d.filter(x=>isFinite(x.preisSack)&&x.preisSack>0);
  const avgW=w.length?w.reduce((a,b)=>a+b.preis,0)/w.length:0;
  const avgS=s.length?s.reduce((a,b)=>a+b.preisSack,0)/s.length:0;

  return d.map(x=>{
    x.keinPreisWerk = !(isFinite(x._preisOrig) && x._preisOrig>0);
    x.keinPreisSack = !(isFinite(x._preisSackOrig) && x._preisSackOrig>0);

    // F√ºr Darstellung darf Durchschnitt gesetzt werden
    if(x.keinPreisWerk) x.preis = avgW;
    if(x.keinPreisSack) x.preisSack = avgS;

    x.farbeWerk = colorForPrice(x._preisOrig, x.keinPreisWerk);
    x.farbeSack = colorForPrice(x._preisSackOrig, x.keinPreisSack);
    return x;
  });
}

/*** ====== PARSER (S√§gerestholz) ====== ***/
function normProduktName(p){
  const s = lc(p);
  if (s.includes("hackschnitzel")) return "hackschnitzel";
  if (s.includes("s√§gesp√§ne") || s.includes("saegespaene") || s.includes("s√§gespaene") || s.includes("saegesp√§ne")) return "saegespaene";
  if (s.includes("siebmaterial")) return "siebmaterial";
  return "";
}

function parseSaegerestholzFirmen(rows){
  const keys = Object.keys(rows[0]||{});
  const lk = k=>lc(k);

  const pick = (cands) => keys.find(k=>cands.includes(lk(k)));
  const firmaKey = pick(["firma","name","werk"]) || keys[0];
  const plzKey   = pick(["plz","zip","postcode","postleitzahl"]) || "plz";
  const ortKey   = pick(["ort","stadt","adresse","standort","location"]) || "ort";
  const landKey  = pick(["land","country"]) || "land";

  const zertKeyQ = keys[16];
  const zertKeyFallback = keys.find(k => ["zertifikate","zertifikat","zert","cert"].includes(lk(k)));
  const zertKey = zertKeyQ || zertKeyFallback;

  const produktKeys = keys.filter(k => lk(k).startsWith("produkt"));
  const preisKeys   = keys.filter(k => lk(k).startsWith("preis"));

  return rows.map(x=>{
    const prices = {};
    const pairs = Math.max(produktKeys.length, preisKeys.length);

    for(let i=0;i<pairs;i++){
      const pKey = produktKeys[i];
      const rKey = preisKeys[i];
      const prodRaw = pKey ? str(x[pKey]) : "";
      const priceVal = rKey ? num(x[rKey]) : NaN;
      const pn = normProduktName(prodRaw);
      if(pn){
        if(isFinite(priceVal) && priceVal>0) prices[pn]=priceVal;
        else if(!(pn in prices)) prices[pn]=0;
      }
    }

    const land = str(x[landKey]);
    return {
      firma: str(x[firmaKey]),
      plz: str(x[plzKey]),
      ort: str(x[ortKey]),
      land,
      zert: zertKey ? str(x[zertKey]) : "",
      prices,
      country_code: countryCodeFromLand(land)
    };
  }).filter(w=>w.firma && (w.plz || w.ort));
}

function parseSaegerestholzKunden(rows){
  const keys = Object.keys(rows[0]||{});
  const pick = (cands) => keys.find(k=>cands.includes(lc(k)));

  const nameKey = pick(["kunde","name","firma","unternehmen"]) || keys[0];
  const plzKey  = pick(["plz","zip","postcode","postleitzahl"]) || "plz";
  const ortKey  = pick(["ort","stadt","adresse","standort","location"]) || "ort";
  const landKey = pick(["land","country"]) || "land";

  return rows.map(x=>{
    const land = str(x[landKey]);
    return {
      name: str(x[nameKey]),
      plz: str(x[plzKey]),
      ort: str(x[ortKey]),
      land,
      country_code: countryCodeFromLand(land)
    };
  }).filter(k=>k.name && (k.plz || k.ort));
}

function buildQueriesPLZOrtLand(obj){
  const plz=(obj.plz||"").trim();
  const ort=(obj.ort||"").trim();
  const land=(obj.land||"").trim();
  const q1=`${plz} ${ort}, ${land}`.replace(/\s+/g," ").trim();
  const q2=`${plz} ${ort}`.replace(/\s+/g," ").trim();
  const q3=`${ort}, ${land}`.replace(/\s+/g," ").trim();
  const q4=`${ort}`.trim();
  return [q1,q2,q3,q4].filter(Boolean);
}

/*** ====== LOADERS ====== ***/
async function loadWerkeForUnit(unit){
  if(unit==="pellets" && werkePellets) return werkePellets;
  if(unit==="streusalz" && werkeStreusalz) return werkeStreusalz;
  if(unit==="saegerestholz" && werkeSaegerestholz) return werkeSaegerestholz;

  if(unit==="saegerestholz"){
    const data = await new Promise(res=>Papa.parse(sheetUrlFirmenSaegerestholz,{
      download:true, header:true, skipEmptyLines:true,
      complete:r=>{ try{ res(parseSaegerestholzFirmen(r.data||[])) }catch(e){ res([]) } }
    }));
    werkeSaegerestholz = data;
    return data;
  }

  const url = (unit==="pellets") ? sheetUrlFirmenPellets : sheetUrlFirmenStreusalz;

  const data = await new Promise(res=>Papa.parse(url,{
    download:true, header:false, skipEmptyLines:true,
    complete:r=>{ try{ res(normalizePreise(parseFirmenArray(r.data||[]))) }catch(e){ res([]) } }
  }));

  if(unit==="pellets") werkePellets = data;
  else werkeStreusalz = data;
  return data;
}

async function loadKundenForUnit(unit){
  if(unit==="pellets" && kundenPellets) return kundenPellets;
  if(unit==="streusalz" && kundenStreusalz) return kundenStreusalz;
  if(unit==="saegerestholz" && kundenSaegerestholz) return kundenSaegerestholz;

  if(unit==="saegerestholz"){
    const data = await new Promise(res=>Papa.parse(sheetUrlKundenSaegerestholz,{
      download:true, header:true, skipEmptyLines:true,
      complete:r=>{ try{ res(parseSaegerestholzKunden(r.data||[])) }catch(e){ res([]) } }
    }));
    kundenSaegerestholz = data;
    return data;
  }

  const url = (unit==="pellets") ? sheetUrlKundenPellets : sheetUrlKundenStreusalz;

  const data = await new Promise(res=>Papa.parse(url,{
    download:true, header:true, skipEmptyLines:true,
    complete:r=>{ try{ res(parseKunden(r.data||[])) }catch(e){ res([]) } }
  }));

  if(unit==="pellets") kundenPellets = data;
  else kundenStreusalz = data;
  return data;
}

/*** ====== COUNTRY ====== ***/
function getSelectedCountries(){
  const s=[...document.querySelectorAll(".countryChk")].filter(c=>c.checked).map(c=>c.value);
  return (!s.length||s.includes("all"))?["all"]:s;
}
function updateCountryButtonLabel(){
  const s=getSelectedCountries();
  if(s.length===1&&s[0]==="all") return countryDropdownBtn.textContent="Alle L√§nder";
  const names={be:"BE",dk:"DK",de:"DE",ee:"EE",fi:"FI",fr:"FR",it:"IT",lv:"LV",lt:"LT",nl:"NL",at:"AT",pl:"PL",se:"SE",ch:"CH",sk:"SK",cz:"CZ",gb:"UK"};
  countryDropdownBtn.textContent=s.map(c=>names[c]||c.toUpperCase()).join(", ");
}

/*** ====== TOOLTIP ====== ***/
function tooltipFirma(m){
  if(isSaegerestholz()){
    const place = `${m.plz ? m.plz+" " : ""}${m.ort||""}`.trim();
    const z = m.zert ? `<br><b>Zertifikat:</b> ${m.zert}` : "";
    const h = m.prices?.hackschnitzel;
    const s = m.prices?.saegespaene;
    const i = m.prices?.siebmaterial;
    const lineH = (h!==undefined) ? `<b>Hackschnitzel:</b> ${isFinite(h)&&h>0 ? h.toFixed(2)+" ‚Ç¨" : "‚Äì"}` : "";
    const lineS = (s!==undefined) ? `<b>S√§gesp√§ne:</b> ${isFinite(s)&&s>0 ? s.toFixed(2)+" ‚Ç¨" : "‚Äì"}` : "";
    const lineI = (i!==undefined) ? `<b>Siebmaterial:</b> ${isFinite(i)&&i>0 ? i.toFixed(2)+" ‚Ç¨" : "‚Äì"}` : "";
    const lines = [lineH,lineS,lineI].filter(Boolean).join("<br>");
    return `<b>${m.firma}</b><br>${place}${m.land?`<br>${m.land}`:""}${z}${lines?`<br>${lines}`:""}`;
  }

  const useSack = sackAktiv();
  const p = (isPellets() && useSack)
    ? (m.keinPreisSack ? NaN : m._preisSackOrig)
    : (m.keinPreisWerk ? NaN : m._preisOrig);

  const preisTxt = (isFinite(p)&&p>0) ? `${p.toFixed(2)} ‚Ç¨` : "‚Äì";
  const z=m.zert?`<br><b>Zertifikat:</b> ${m.zert}`:"";
  const s=(isPellets() && m.sack)?`<br><b>Sackware:</b> ${m.sack}`:"";
  return `<b>${m.firma}</b><br>${m.ort}${m.land?`<br>${m.land}`:""}<br>${preisTxt}${z}${s}`;
}

/*** ===== ROUTE / DIST ===== */
function luftlinieKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon), la1=toRad(a.lat), la2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}
async function osrmDistKm(a,b){
  const url=`https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
  const res=await fetch(url);
  const data=res.ok?await res.json():null;
  if(data?.routes?.length) return data.routes[0].distance/1000;
  return null;
}

// Pellets/Streusalz Formel
function calcDeliveredPricePelletsStreu(distKm, basePrice){
  const preisProKm = distKm < 250 ? 2.15 : 1.85;
  const berechnung = (distKm/24) * preisProKm;
  const margeFaktor = (currentUnit === "streusalz") ? 1.20 : 1.05;
  const total = (berechnung + (basePrice||0)) * margeFaktor;
  return { total, preisProKm, margeFaktor };
}

// S√§gerestholz Formeln (wie vorher)
const S_MARGE = 1.05;
const HACKS_TEILER = 90;
const HACKS_KM = 2.15;
const SAEG_TEILER = 90;
const SAEG_KM = 2.15;
const SIEB_TONNE = 21.50;
const SIEB_KM_SATZ = 1.85;
const SIEB_ATRO = 11.8;

function calcHackschnitzel(ek, km){
  if(!(isFinite(ek)&&ek>0)) return null;
  return (ek + ((km * HACKS_KM) / HACKS_TEILER)) * S_MARGE;
}
function calcSaegespaene(ek, km){
  if(!(isFinite(ek)&&ek>0)) return null;
  return (ek + ((km * SAEG_KM) / SAEG_TEILER)) * S_MARGE;
}
function calcSiebmaterial(ek, km){
  if(!(isFinite(ek)&&ek>0)) return null;
  return (((ek * SIEB_TONNE) + (SIEB_KM_SATZ * km)) / SIEB_ATRO) * S_MARGE;
}

/*** ===== BUILD MAP ===== */
async function buildMap(){
  const myToken = ++buildToken;
  for(const m of alleMarker){ try{ map.removeLayer(m.marker); }catch(e){} }
  alleMarker=[];
  if(searchMarker){ try{ map.removeLayer(searchMarker);}catch(e){} searchMarker=null; }

  const bounds=L.latLngBounds();

  // Firmen
  for(const w of werke){
    if(myToken !== buildToken) return;

    // geocode
    let c=null;
    if(isSaegerestholz()){
      const qs = buildQueriesPLZOrtLand(w);
      for(const q of qs){
        c = geoCache[q]?.country_code ? geoCache[q] : await geocodeCached(q);
        if(c) break;
      }
    }else{
      c = geoCache[w.ort]?.country_code ? geoCache[w.ort] : await geocodeCached(w.ort);
    }
    if(!c) continue;

    let farbe = "green";

    if(isSaegerestholz()){
      const ap = activePriceForSaegerestholzWerk(w);
      farbe = colorForPrice(ap.price, ap.keinPreis);
      const cm=L.circleMarker([c.lat,c.lon],{radius:8,color:farbe,fillColor:farbe,fillOpacity:.85})
        .bindTooltip("",{sticky:true})
        .on("tooltipopen",()=>cm.getTooltip().setContent(tooltipFirma({...w,country_code:c.country_code})))
        .on("click",()=>pickPoint(w.firma,{lat:c.lat,lon:c.lon}));

      alleMarker.push({type:"firma",marker:cm,...w,country_code:(w.country_code||c.country_code||""), _coord:{lat:c.lat,lon:c.lon}});
      bounds.extend([c.lat,c.lon]);
      continue;
    }

    // pellets/streu
    farbe = (isPellets() && sackAktiv()) ? w.farbeSack : w.farbeWerk;
    const cm=L.circleMarker([c.lat,c.lon],{radius:8,color:farbe,fillColor:farbe,fillOpacity:.85})
      .bindTooltip("",{sticky:true})
      .on("tooltipopen",()=>cm.getTooltip().setContent(tooltipFirma({...w,country_code:c.country_code})))
      .on("click",()=>pickPoint(w.firma,{lat:c.lat,lon:c.lon}));

    alleMarker.push({type:"firma",marker:cm,...w,country_code:(w.country_code||c.country_code||""), _coord:{lat:c.lat,lon:c.lon}});
    bounds.extend([c.lat,c.lon]);
  }

  // Kunden
  for(const k of kunden){
    if(myToken !== buildToken) return;

    let c=null;
    if(isSaegerestholz()){
      const qs = buildQueriesPLZOrtLand(k);
      for(const q of qs){
        c = geoCache[q]?.country_code ? geoCache[q] : await geocodeCached(q);
        if(c) break;
      }
    }else{
      c = geoCache[k.ort]?.country_code ? geoCache[k.ort] : await geocodeCached(k.ort);
    }
    if(!c) continue;

    let type="kunde", icon=iconBlue;

    if(isPellets()){
      const isSackOnly=(k.sackware==="ja")&&(k.lose!=="ja");
      const isSonstige=(k.sonstige==="ja");
      type=isSonstige?"sonstige":isSackOnly?"sackkunde":"kunde";
      icon=isSonstige?iconOrange:isSackOnly?iconPurple:iconBlue;
    }else if(isStreusalz()){
      type="streukunde";
      icon=iconBlue;
    }else if(isSaegerestholz()){
      type="saegKunde";
      icon=iconBlue;
    }

    const name = k.name || k.kunde || k.firma || "Kunde";
    const ortText = isSaegerestholz()
      ? `${k.plz ? k.plz+" " : ""}${k.ort||""}`.trim()
      : (k.ort||"");

    const mk=L.marker([c.lat,c.lon],{icon})
      .bindTooltip(`<b>${name}</b><br>${ortText}<br><small>Rechtsklick: Zielpreis-Suche</small>`,{sticky:true})
      .on("click",()=>pickPoint(name,{lat:c.lat,lon:c.lon}))
      .on("contextmenu",(e)=>{
        e.originalEvent?.preventDefault?.();
        openCustomerMenu({ name, ort: ortText }, {lat:c.lat,lon:c.lon}, e.originalEvent);
      });

    alleMarker.push({type,marker:mk,...k,name,ort: ortText,country_code:(k.country_code||c.country_code||""), _coord:{lat:c.lat,lon:c.lon}});
    bounds.extend([c.lat,c.lon]);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(.15));
  updateLayers();
}

/*** ===== S√ÑGERESTHOLZ ACTIVE PRICE ===== */
function activePriceForSaegerestholzWerk(w){
  const showH = s_chkHacks.checked;
  const showS = s_chkSaeg.checked;
  const showI = s_chkSieb.checked;

  const pH = w.prices?.hackschnitzel;
  const pS = w.prices?.saegespaene;
  const pI = w.prices?.siebmaterial;

  const list = [];
  if(showH && isFinite(pH) && pH>0) list.push(pH);
  if(showS && isFinite(pS) && pS>0) list.push(pS);
  if(showI && isFinite(pI) && pI>0) list.push(pI);

  if(!list.length) return { price: 0, keinPreis:true };
  return { price: Math.min(...list), keinPreis:false };
}

/*** ===== ROUTE DISPLAY ===== */
async function showRouteByCoords(aLabel,aCoord,bLabel,bCoord){
  const osrm=`https://router.project-osrm.org/route/v1/driving/${aCoord.lon},${aCoord.lat};${bCoord.lon},${bCoord.lat}?overview=full&geometries=geojson`;
  let distKm=null, coords=null, dashed=false, durStr="";
  try{
    const res=await fetch(osrm);
    const data=res.ok?await res.json():null;
    if(data?.routes?.length){
      const r=data.routes[0];
      distKm=r.distance/1000;
      const min=r.duration/60, h=Math.floor(min/60), m=Math.round(min%60);
      durStr=h?`${h}h ${m}min`:`${m}min`;
      coords=r.geometry.coordinates.map(c=>[c[1],c[0]]);
    }
  }catch(e){}
  if(!distKm){
    distKm=luftlinieKm(aCoord,bCoord);
    coords=[[aCoord.lat,aCoord.lon],[bCoord.lat,bCoord.lon]];
    dashed=true;
  }

  // Preise je Unit
  let popupExtra = "";
  if(isSaegerestholz()){
    // wenn Start oder Ziel Werk ist: nimm dessen Preise
    const firm = werke.find(w=>w.firma===aLabel || w.firma===bLabel);
    const pH = firm?.prices?.hackschnitzel;
    const pS = firm?.prices?.saegespaene;
    const pI = firm?.prices?.siebmaterial;

    const tH = (isFinite(pH)&&pH>0) ? calcHackschnitzel(pH, distKm) : null;
    const tS = (isFinite(pS)&&pS>0) ? calcSaegespaene(pS, distKm) : null;
    const tI = (isFinite(pI)&&pI>0) ? calcSiebmaterial(pI, distKm) : null;

    popupExtra = `
      <hr style="border:none;height:1px;background:#eee;margin:8px 0;">
      <b>Hackschnitzel:</b> ${tH!==null ? `<span style="color:green;font-weight:800">${tH.toFixed(2)} ‚Ç¨</span>`:"‚Äì"}<br>
      <b>S√§gesp√§ne:</b> ${tS!==null ? `<span style="color:green;font-weight:800">${tS.toFixed(2)} ‚Ç¨</span>`:"‚Äì"}<br>
      <b>Siebmaterial:</b> ${tI!==null ? `<span style="color:green;font-weight:800">${tI.toFixed(2)} ‚Ç¨</span>`:"‚Äì"}
    `;
  }else{
    const useSack = sackAktiv();
    const firm = werke.find(w=>w.firma===aLabel || w.firma===bLabel);
    const base = firm ? ((isPellets() && useSack) ? firm.preisSack : firm.preis) : 0;
    const {total, preisProKm, margeFaktor} = calcDeliveredPricePelletsStreu(distKm, base);
    const margeTxt = (margeFaktor===1.20) ? "20%" : "5%";
    popupExtra = `
      <b>Preis pro km:</b> ${preisProKm.toFixed(2)} ‚Ç¨<br>
      <b>${(isPellets() && useSack)?"Sackware-Preis":"Werkspreis"}:</b> ${(base||0).toFixed(2)} ‚Ç¨<br>
      <b>Marge:</b> ${margeTxt}<br>
      <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${total.toFixed(2)} ‚Ç¨</span>
    `;
  }

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{color:"blue",weight:5,opacity:.85,dashArray:dashed?"8 8":null}).addTo(map);
  const mid=coords[Math.floor(coords.length/2)];

  L.popup().setLatLng(mid).setContent(`
    <b>Route:</b> ${aLabel} ‚Üî ${bLabel}<br>
    <b>Entfernung:</b> ${distKm.toFixed(1)} km ${dashed?"(Luftlinie)":"(Stra√üe)"}<br>
    ${durStr?`<b>Dauer:</b> ${durStr}<br>`:""}
    ${popupExtra}
    ${dashed?`<br><small>Keine Stra√üenroute verf√ºgbar ‚Üí Luftlinie gestrichelt.</small>`:""}
  `).openOn(map);

  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}
function showRoute(a,b){ return showRouteByCoords(a.label, a.coord, b.label, b.coord); }

/*** ‚úÖ Ergebnis highlight */
function highlightWerkMarker(werkFirma){
  resetMatchHighlights();
  const m = alleMarker.find(x => x.type==="firma" && (x.firma === werkFirma));
  if(!m || !m.marker?.setStyle) return;

  try{
    const o = m.marker.options || {};
    m._origStyle = { color: o.color, fillColor: o.fillColor, fillOpacity: o.fillOpacity, weight:o.weight };
  }catch(e){}

  m.marker.setStyle({ weight: 4, fillOpacity: 1 });
  matchMarkers.push(m);

  setTimeout(()=> {
    try{ if(m.marker.setStyle && m._origStyle) m.marker.setStyle(m._origStyle); }catch(e){}
  }, 3000);
}

/*** ===== CONTEXT MENU (Zielpreis) ===== */
function openCustomerMenu(kunde, coord, mouseEvent){
  closeCtx();
  resetMatchHighlights();
  ctxCustomer = {name:kunde.name, ort:kunde.ort, coord};

  const p = map.mouseEventToContainerPoint(mouseEvent);
  const cont = map.getContainer();

  ctxEl = document.createElement("div");
  ctxEl.className = "ctxbox";
  ctxEl.style.left = Math.min(Math.max(10, p.x), cont.clientWidth-300) + "px";
  ctxEl.style.top  = Math.min(Math.max(10, p.y), cont.clientHeight-320) + "px";

  let typeRow = "";
  if(isPellets()){
    typeRow = `
      <div class="row" style="margin-top:10px">
        <select id="ctxType">
          <option value="lose">Pellets lose</option>
          <option value="sack">Sackware</option>
        </select>
      </div>
    `;
  } else if(isSaegerestholz()){
    typeRow = `
      <div class="row" style="margin-top:10px">
        <select id="ctxType">
          <option value="hackschnitzel">Hackschnitzel</option>
          <option value="saegespaene">S√§gesp√§ne</option>
          <option value="siebmaterial">Siebmaterial</option>
        </select>
      </div>
    `;
  } else {
    typeRow = `
      <div class="row" style="margin-top:10px">
        <div class="small"><b>Unit:</b> Streusalz</div>
      </div>
    `;
  }

  ctxEl.innerHTML = `
    <div class="topbar">
      <div style="min-width:0">
        <b style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.name}</b>
        <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.ort}</div>
      </div>
      <button class="xbtn" id="ctxClose">√ó</button>
    </div>

    ${typeRow}

    <div class="row">
      <input id="ctxPrice" type="number" step="0.01" placeholder="Zielpreis (‚Ç¨) eingeben‚Ä¶">
    </div>

    <div class="results" id="ctxResults"></div>
  `;

  cont.appendChild(ctxEl);
  stopEvt(ctxEl);

  ctxEl.querySelector("#ctxClose").addEventListener("click", closeCtx);

  const input = ctxEl.querySelector("#ctxPrice");
  input.focus();

  input.addEventListener("keydown", async (e)=>{
    if(e.key !== "Enter") return;
    const target = num(input.value);
    const type = (isPellets() || isSaegerestholz()) ? (ctxEl.querySelector("#ctxType").value) : "streu";
    if(!isFinite(target) || target<=0){ alert("Bitte einen g√ºltigen Zielpreis eingeben."); return; }
    await runTargetSearch(type, target);
  });

  if(isPellets() || isSaegerestholz()){
    const sel = ctxEl.querySelector("#ctxType");
    sel.addEventListener("change", async ()=>{
      const target = num(input.value);
      if(isFinite(target) && target>0) await runTargetSearch(sel.value, target);
    });
  }
}

async function runTargetSearch(type, targetPrice){
  if(!ctxEl || !ctxCustomer) return;
  const resBox = ctxEl.querySelector("#ctxResults");
  resBox.innerHTML = `<div class="small">Suche‚Ä¶</div>`;

  // sichtbare Werke
  const firmsVisible = alleMarker
    .filter(m => m.type==="firma" && map.hasLayer(m.marker));

  // Kandidaten (echte Preise!)
  const candidates = [];

  for(const m of firmsVisible){
    if(isSaegerestholz()){
      const base = m.prices?.[type];
      if(!(isFinite(base) && base>0)) continue;
      candidates.push({ ...m, base });
      continue;
    }

    const isSack = isPellets() && (type === "sack");
    const hasReal = isSack ? !m.keinPreisSack : !m.keinPreisWerk;
    const base = isSack ? m._preisSackOrig : m._preisOrig;
    if(!(hasReal && isFinite(base) && base>0)) continue;
    candidates.push({ ...m, base });
  }

  if(!candidates.length){
    resBox.innerHTML = `<div class="small">Keine passenden Werke mit <b>echtem</b> Preis gefunden (Filter/Layer beachten).</div>`;
    lastMatches = [];
    return;
  }

  // erst Luftlinie sortieren, dann OSRM f√ºr die n√§chsten
  const c = ctxCustomer.coord;
  const pre = candidates.map(f=>{
    const d0 = luftlinieKm({lat:c.lat,lon:c.lon},{lat:f._coord.lat,lon:f._coord.lon});
    return {...f, d0};
  }).sort((a,b)=>a.d0-b.d0);

  const LIMIT = 40;
  const shortlist = pre.slice(0, Math.min(LIMIT, pre.length));

  const matches = [];
  for(const f of shortlist){
    let dist = null;
    try{ dist = await osrmDistKm({lat:c.lat,lon:c.lon},{lat:f._coord.lat,lon:f._coord.lon}); }catch(e){}
    if(!dist) dist = f.d0;

    let total = null;

    if(isSaegerestholz()){
      if(type==="hackschnitzel") total = calcHackschnitzel(f.base, dist);
      if(type==="saegespaene") total = calcSaegespaene(f.base, dist);
      if(type==="siebmaterial") total = calcSiebmaterial(f.base, dist);
    } else {
      total = calcDeliveredPricePelletsStreu(dist, f.base).total;
    }

    if(isFinite(total) && total <= targetPrice){
      matches.push({ f, distKm: dist, total });
    }
  }

  matches.sort((a,b)=>a.total-b.total);

  if(!matches.length){
    resBox.innerHTML = `<div class="small">Keine Firma unter ${targetPrice.toFixed(2)} ‚Ç¨ gefunden (nur mit echten Preisen).</div>`;
    lastMatches = [];
    return;
  }

  lastMatches = matches;

  let pill = "Streusalz";
  let baseLabel = "Werkspreis";
  if(isPellets()){
    pill = (type==="sack"?"Sackware":"Lose");
    baseLabel = (type==="sack" ? "Sackware-Preis" : "Werkspreis");
  }
  if(isSaegerestholz()){
    pill = (type==="hackschnitzel"?"Hacks":type==="saegespaene"?"S√§gesp√§ne":"Sieb");
    baseLabel = "Werkspreis";
  }

  resBox.innerHTML = matches.slice(0,20).map((m,i)=>`
    <div class="item" data-i="${i}">
      <div><b>${m.f.firma}</b><span class="pill">${pill}</span></div>
      <div class="small">${m.f.ort}${m.f.land?`, ${m.f.land}`:""}</div>
      <div class="small"><b>Entfernung:</b> ${m.distKm.toFixed(1)} km</div>
      <div class="small"><b>${baseLabel}:</b> ${m.f.base.toFixed(2)} ‚Ç¨</div>
      <div><b>Lieferpreis:</b> ${m.total.toFixed(2)} ‚Ç¨</div>
      <div class="small">Klick ‚Üí Route anzeigen</div>
    </div>
  `).join("");

  resBox.querySelectorAll(".item").forEach(el=>{
    el.addEventListener("click", async ()=>{
      const i = +el.getAttribute("data-i");
      const hit = lastMatches[i];
      if(!hit) return;

      highlightWerkMarker(hit.f.firma);

      await showRouteByCoords(
        ctxCustomer.name,
        { lat: ctxCustomer.coord.lat, lon: ctxCustomer.coord.lon },
        hit.f.firma,
        { lat: hit.f._coord.lat, lon: hit.f._coord.lon }
      );
    });
  });
}

/*** ===== LAYERS ===== */
function updateLayers(){
  if(routeLine){map.removeLayer(routeLine);routeLine=null}
  map.closePopup(); selectedPoints=[];
  if(searchMarker){map.removeLayer(searchMarker);searchMarker=null}

  const selected=getSelectedCountries(), noCountry=(selected.length===1&&selected[0]==="all");
  const gr=chkGruen.checked, or=chkOrange.checked, ro=chkRot.checked, ga=chkGrau.checked;

  for(const m of alleMarker){
    if(map.hasLayer(m.marker)) map.removeLayer(m.marker);

    // Landfilter
    if(!noCountry && (!m.country_code || !selected.includes(m.country_code))) continue;

    // Kunden je Unit
    if(isPellets()){
      if(m.type==="kunde"){ if(chkKunden.checked) map.addLayer(m.marker); continue; }
      if(m.type==="sackkunde"){ if(chkSackKunden.checked) map.addLayer(m.marker); continue; }
      if(m.type==="sonstige"){ if(chkSonstigeKunden.checked) map.addLayer(m.marker); continue; }
    }
    if(isStreusalz()){
      if(m.type==="streukunde"){ if(chkKundenStreusalz.checked) map.addLayer(m.marker); continue; }
    }
    if(isSaegerestholz()){
      if(m.type==="saegKunde"){ if(chkKundenSaegerestholz.checked) map.addLayer(m.marker); continue; }
    }

    // ---- FIRMA FILTER ----
    if(m.type!=="firma") continue;

    // Zertifikate je Unit
    if(isPellets()){
      const z=lc(m.zert);
      const en=chkEnPlus.checked, din=chkDINplus.checked, sure=chkSURE.checked, cpp=chkCPP.checked, ohne=chkOhneZert.checked;
      let zertOK=false;
      if(z.includes("enplus")&&en) zertOK=true;
      if(z.includes("dinplus")&&din) zertOK=true;
      if(z.includes("sure")&&sure) zertOK=true;
      if(z.includes("cpp")&&cpp) zertOK=true;
      if(!z&&ohne) zertOK=true;
      if(!zertOK) continue;

      // Sackfilter
      const wantF = chkSackFireflies.checked;
      const want15 = chkSack15kg.checked;
      const useSack = (wantF || want15);
      if(useSack){
        const s=lc(m.sack).replace(/\s+/g," ");
        const hasF=s.includes("fireflies"), has15=s.includes("15 kg")||s.includes("15kg");
        if(wantF && !want15 && !hasF) continue;
        if(want15 && !wantF && !has15) continue;
        if(wantF && want15 && !(hasF||has15)) continue;
      }

      const farbe = (useSack) ? m.farbeSack : m.farbeWerk;
      const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
      if(!ok) continue;

      m.marker.setStyle?.({color:farbe,fillColor:farbe});
      map.addLayer(m.marker);
      continue;
    }

    if(isStreusalz()){
      const z=lc(m.zert);
      const en=z_chkEnPlus.checked, din=z_chkDINplus.checked, sure=z_chkSURE.checked, cpp=z_chkCPP.checked, ohne=z_chkOhneZert.checked;
      let zertOK=false;
      if(z.includes("enplus")&&en) zertOK=true;
      if(z.includes("dinplus")&&din) zertOK=true;
      if(z.includes("sure")&&sure) zertOK=true;
      if(z.includes("cpp")&&cpp) zertOK=true;
      if(!z&&ohne) zertOK=true;
      if(!zertOK) continue;

      const farbe = m.farbeWerk;
      const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
      if(!ok) continue;

      m.marker.setStyle?.({color:farbe,fillColor:farbe});
      map.addLayer(m.marker);
      continue;
    }

    if(isSaegerestholz()){
      // Produktfilter: mindestens eins
      if(!s_chkHacks.checked && !s_chkSaeg.checked && !s_chkSieb.checked) continue;

      // Zertfilter
      const z=lc(m.zert);
      const sure = s_chkSURE.checked;
      const pefc = s_chkPEFC.checked;
      const ohne = s_chkOhneZert.checked;

      let zertOK=false;
      if(z.includes("sure") && sure) zertOK=true;
      if(z.includes("pefc") && pefc) zertOK=true;
      if(!z && ohne) zertOK=true;
      if(!zertOK) continue;

      // Farbe aus aktivem Produktmix
      const ap = activePriceForSaegerestholzWerk(m);
      const farbe = colorForPrice(ap.price, ap.keinPreis);
      const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
      if(!ok) continue;

      m.marker.setStyle?.({color:farbe,fillColor:farbe});
      map.addLayer(m.marker);
      continue;
    }
  }
}

/*** ===== PICK / CLEAR ===== */
function pickPoint(label,coord){
  selectedPoints.push({label,coord});
  if(selectedPoints.length===2){
    const [a,b]=selectedPoints;
    selectedPoints=[];
    showRoute(a,b);
  }
}
function clearRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
  map.closePopup();
  selectedPoints = [];
}

/*** ===== UNIT UI ===== */
function applyUnitUIOnly(){
  // Cert sections
  certPellets.classList.toggle("hidden", !isPellets());
  certSaegerestholz.classList.toggle("hidden", !isSaegerestholz());
  certStreusalz.classList.toggle("hidden", !isStreusalz());

  // Customer filters
  kundenFilterPellets.classList.toggle("hidden", !isPellets());
  kundenFilterSaegerestholz.classList.toggle("hidden", !isSaegerestholz());
  kundenFilterStreusalz.classList.toggle("hidden", !isStreusalz());

  // Reset pellets sack checks when not pellets
  if(!isPellets()){
    chkSackFireflies.checked = false;
    chkSack15kg.checked = false;
  }
}

/*** ===== UNIT SWITCH ===== */
async function switchUnit(newUnit){
  currentUnit = newUnit;
  applyUnitUIOnly();
  closeCtx();
  clearRoute();

  werke = await loadWerkeForUnit(currentUnit);
  kunden = await loadKundenForUnit(currentUnit);

  await buildMap();
}

unitSelect.addEventListener("change", async ()=>{ await switchUnit(unitSelect.value); });

/*** ===== EVENTS ===== */
map.on("click", (e)=>{
  if(ctxEl) return;
  if(routeLine){
    const t = e.originalEvent?.target;
    if(t && (t.tagName === "path" || t.closest?.("path"))) return;
  }
  clearRoute();
});
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") clearRoute(); });

document.addEventListener("mousedown",(e)=>{
  if(!ctxEl) return;
  if(ctxEl.contains(e.target)) return;
  closeCtx();
});
map.on("movestart", closeCtx);
map.on("zoomstart", closeCtx);

document.addEventListener("change",e=>{
  if(e.target?.matches('input[type="checkbox"]')){
    if(e.target.classList.contains("countryChk")){
      if(e.target.value==="all"&&e.target.checked) [...document.querySelectorAll(".countryChk")].forEach(x=>x.value!=="all"&&(x.checked=false));
      if(e.target.value!=="all"&&e.target.checked) document.querySelector('.countryChk[value="all"]').checked=false;
      updateCountryButtonLabel();
    }
    updateLayers();
  }
});

countryDropdownBtn.addEventListener("click",()=>countryDropdownMenu.style.display=(countryDropdownMenu.style.display==="block"?"none":"block"));
document.addEventListener("click",e=>{if(!countryDropdown.contains(e.target)) countryDropdownMenu.style.display="none"});

/*** ===== SEARCH ===== */
searchInput.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;
  const raw=e.target.value.trim(); if(!raw) return;

  closeCtx();
  clearRoute();
  if(searchMarker){ try{ map.removeLayer(searchMarker); }catch(err){} searchMarker=null; }

  const q=lc(raw);
  const matches=alleMarker.filter(m=>{
    const name=lc(m.firma||m.name), ort=lc(m.ort||""), tip=lc(m.marker.getTooltip?.()?.getContent?.()||"");
    return name.includes(q)||ort.includes(q)||tip.includes(q);
  });

  const bounds=L.latLngBounds();
  matches.forEach((m,i)=>{
    if(!map.hasLayer(m.marker)) map.addLayer(m.marker);
    bounds.extend(m.marker.getLatLng());
    if(i===0) m.marker.openTooltip?.();
  });

  const geo=await geocodeCached(raw);
  if(geo){
    const ll=[geo.lat,geo.lon];
    const coordObj = {lat: geo.lat, lon: geo.lon};

    searchMarker=L.circleMarker(ll,{radius:8,color:"blue",fillColor:"blue",fillOpacity:.5}).addTo(map);
    searchMarker.bindTooltip(`<b>${raw}</b><br><small>Rechtsklick: Zielpreis-Suche</small>`,{sticky:true});

    searchMarker.on("contextmenu",(ev)=>{
      ev.originalEvent?.preventDefault?.();
      openCustomerMenu({ name: raw, ort: geo.country || raw }, coordObj, ev.originalEvent);
    });

    bounds.extend(ll);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(.2));
  else alert("Kein Treffer gefunden.");
});

/*** ===== INIT ===== */
(async()=>{
  updateCountryButtonLabel();
  applyUnitUIOnly();
  await switchUnit(unitSelect.value);
})();
</script>
</body>
</html>
