<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke ‚Äì Europa Preiskarte</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body{height:100%;margin:0;}
    #map{width:100%;height:100%;}

    .legend, .cert-box{
      position:absolute;background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);font:14px/1.3 system-ui,Arial,sans-serif;
    }
    .cert-box{bottom:12px;left:12px;z-index:1000;}
    .legend{bottom:12px;right:12px;min-width:180px;z-index:3000;}

    .cert-box input[type="checkbox"],
    .legend input[type="checkbox"]{width:14px;height:14px;margin-right:5px;vertical-align:middle;}

    .search-box{
      position:absolute;top:12px;right:12px;z-index:1500;background:#fff;
      padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px system-ui,Arial,sans-serif;width:260px;
    }

    /* nur Textfeld stylen */
    .search-box input[type="text"]{
      width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;
      outline:none;box-sizing:border-box;margin-left:4px;
    }

    .cert-box hr{border:none;height:1px;background:#eee;margin:6px 0;}

    .country-dropdown{position:relative;display:block;width:100%;margin-top:8px;}
    .country-dropdown-button{
      width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;
      padding:4px 6px;text-align:left;cursor:pointer;box-sizing:border-box;
    }
    .country-dropdown-button:after{content:"‚ñæ";float:right;opacity:.6;}
    .country-dropdown-menu{
      position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;
      border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      z-index:4000;display:none;min-width:160px;max-height:260px;overflow-y:auto;
      padding:8px 10px;box-sizing:border-box;
    }
    .country-dropdown-menu label{
      display:flex;align-items:center;gap:8px;margin:6px 0;cursor:pointer;user-select:none;
    }
    .country-dropdown-menu label input[type="checkbox"]{
      margin:0;width:14px;height:14px;flex:0 0 auto;
    }

    .status{
      position:absolute;top:12px;left:12px;z-index:5000;background:#fff;
      padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:12px/1.35 system-ui,Arial,sans-serif;max-width:520px;white-space:pre-wrap;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="status" id="statusBox">Lade‚Ä¶</div>

<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶"/>

  <b style="display:block;margin-top:6px;">Land / L√§nder filtern</b>
  <div class="country-dropdown" id="countryDropdown">
    <div class="country-dropdown-button" id="countryDropdownBtn">Alle L√§nder</div>
    <div class="country-dropdown-menu" id="countryDropdownMenu">
      <label><input type="checkbox" class="countryChk" value="all" checked> Alle</label>
      <label><input type="checkbox" class="countryChk" value="de"> Deutschland</label>
      <label><input type="checkbox" class="countryChk" value="at"> √ñsterreich</label>
      <label><input type="checkbox" class="countryChk" value="pl"> Polen</label>
      <label><input type="checkbox" class="countryChk" value="cz"> Tschechien</label>
      <label><input type="checkbox" class="countryChk" value="fr"> Frankreich</label>
      <label><input type="checkbox" class="countryChk" value="ch"> Schweiz</label>
      <label><input type="checkbox" class="countryChk" value="be"> Belgien</label>
      <label><input type="checkbox" class="countryChk" value="sk"> Slowakei</label>
    </div>
  </div>
</div>

<div class="cert-box">
  <b>Zertifikate</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> 1</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> 2</label><br>
  <label><input type="checkbox" id="chkSURE" checked> 3</label><br>
  <label><input type="checkbox" id="chkCPP" checked> 4</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
  <hr>
  <b>Produkt</b><br>
  <label><input type="checkbox" id="chkHackschnitzel" checked> Hackschnitzel</label><br>
  <label><input type="checkbox" id="chkSaegespaene" checked> S√§gesp√§ne</label>
</div>

<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Pelletwerk</label>
</div>

<script>
  const statusBox = document.getElementById("statusBox");
  const setStatus = (t)=>{ if(statusBox) statusBox.textContent = t; };

  // Karte
  const map = L.map("map").setView([51, 11], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    minZoom: 4, maxZoom: 10, attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  function colorForPrice(p, keinPreis) {
    if (keinPreis) return "#9e9e9e";
    if (!p || p <= 0 || isNaN(p)) return "#9e9e9e";
    if (p <= 260) return "green";
    if (p < 285) return "orange";
    return "red";
  }

  // GeoCache
  const geoCache = JSON.parse(localStorage.getItem("geoCacheProdukte_EU") || "{}");

  async function geocodeOnce(q) {
    if (geoCache[q] && geoCache[q].country_code) return geoCache[q];

    const r = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1&accept-language=de`,
      { headers: { "Accept": "application/json" } }
    );
    const d = await r.json();
    if (d.length) {
      const item = d[0];
      const obj = {
        lat: +item.lat,
        lon: +item.lon,
        country: item.address && item.address.country ? item.address.country : "",
        country_code: item.address && item.address.country_code ? item.address.country_code.toLowerCase() : ""
      };
      geoCache[q] = obj;
      localStorage.setItem("geoCacheProdukte_EU", JSON.stringify(geoCache));
      return obj;
    }
    return null;
  }

  // ‚úÖ Fallback: probiert mehrere Varianten
  async function geocodeWithFallback(queries) {
    for (const q of queries) {
      const qq = (q || "").trim();
      if (!qq) continue;
      const res = await geocodeOnce(qq);
      if (res) return res;
    }
    return null;
  }

  // Icon Kunden
  const blauesDreieck = L.divIcon({
    className: "custom-triangle",
    html: `<svg width="24" height="24" viewBox="0 0 24 24">
             <polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/>
           </svg>`,
    iconAnchor: [12,22],
    popupAnchor: [0,-20]
  });

  // Tabellen (GViz CSV)
  const sheetUrlFirmen = "https://docs.google.com/spreadsheets/d/1GIBV-WAyaslfi175jpbif0bHw8YWAhriifM7CtDUB2k/gviz/tq?tqx=out:csv&gid=0";
  const sheetUrlKunden = "https://docs.google.com/spreadsheets/d/148jjtRze9SmuFsDNRfoM_nwEih7GbCzOjMUQEAb78pg/gviz/tq?tqx=out:csv&gid=0";

  async function loadCsvAsObjects(url){
    const res = await fetch(url, { cache: "no-store" });
    const text = await res.text();
    const head = text.slice(0, 200).toLowerCase();
    if (head.includes("<html") || head.includes("<!doctype")) throw new Error("Google liefert HTML statt CSV.");
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    return (parsed.data || []).filter(r => r && Object.keys(r).length);
  }

  // Parser
  function parseFirmen(rows){
    const lc = (s)=>String(s||"").toLowerCase().trim();
    const keys = Object.keys(rows[0]||{});
    const findKey = (cands) => keys.find(k => cands.includes(lc(k)));

    const firmaKey   = findKey(["firma","name","werk"]) || "firma";
    const ortKey     = findKey(["ort","stadt","location","standort","adresse"]) || "ort";
    const plzKey     = findKey(["plz","zip","postcode","postleitzahl"]) || "plz";
    const landKey    = findKey(["land","country"]) || "land";
    const produktKey = findKey(["produkt","produkte","product","products"]) || "produkt";
    const preisKey   = findKey(["preis","price","‚Ç¨/t","euro","euro_t","werkspreis","‚Ç¨/srm","preis_srm"]) || "preis";
    const zertKey    = findKey(["zertifikate","zertifikat","zert","cert"]); // optional

    return rows.map(x => ({
      firma: (x[firmaKey]||"").toString().trim(),
      ort: (x[ortKey]||"").toString().trim(),
      plz: (x[plzKey]||"").toString().trim(),
      land: (x[landKey]||"").toString().trim(),
      produkt: (x[produktKey]||"").toString().trim(),
      preis: parseFloat(String(x?.[preisKey] ?? "0").replace(",", ".")),
      zert: zertKey ? (x?.[zertKey]||"").toString().trim() : ""
    })).filter(w => w.firma && w.ort);
  }

  function parseKunden(rows){
    const lc = (s)=>String(s||"").toLowerCase().trim();
    const keys = Object.keys(rows[0]||{});
    const findKey = (cands) => keys.find(k => cands.includes(lc(k)));

    const kundeKey = findKey(["kunde","name","firma","unternehmen"]) || "kunde";
    const ortKey   = findKey(["ort","stadt","location","adresse","standort"]) || "ort";
    const plzKey   = findKey(["plz","zip","postcode","postleitzahl"]) || "plz";
    const landKey  = findKey(["land","country"]) || "land";

    return rows.map(x => ({
      name: (x[kundeKey]||"").toString().trim(),
      ort: (x[ortKey]||"").toString().trim(),
      plz: (x[plzKey]||"").toString().trim(),
      land: (x[landKey]||"").toString().trim()
    })).filter(k => k.name && k.ort);
  }

  function normalizePreise(daten){
    const g√ºltige = daten.filter(w => isFinite(w.preis) && w.preis > 0);
    const avg = g√ºltige.length ? (g√ºltige.reduce((a,b)=>a+b.preis,0)/g√ºltige.length) : 0;
    return daten.map(w=>{
      if(!isFinite(w.preis) || w.preis<=0){ w.preis=avg; w.keinPreis=true; } else w.keinPreis=false;
      w.farbe = colorForPrice(w.preis, w.keinPreis);
      return w;
    });
  }

  function datasetFromProdukt(p){
    const s = (p || "").toLowerCase();
    if (s.includes("s√§gesp√§ne") || s.includes("saegespaene") || s.includes("s√§gespaene")) return "saegespaene";
    if (s.includes("hackschnitzel")) return "hackschnitzel";
    return "hackschnitzel";
  }

  // Tooltip
  function tooltipHtmlFirma(m){
    const preisTxt = (isFinite(m.preis) && m.preis > 0) ? `${m.preis.toFixed(2)} ‚Ç¨` : "‚Äì";
    const landInfo = m.land ? `<br><b>Land:</b> ${m.land}` : "";
    const produktTxt = (m.dataset === "saegespaene")
      ? "<br><b>Produkt:</b> S√§gesp√§ne"
      : "<br><b>Produkt:</b> Hackschnitzel";
    return `<b>${m.firma}</b><br>${m.ort}${m.plz ? " " + m.plz : ""}${landInfo}<br>${preisTxt}${produktTxt}`;
  }

  // State
  let werke = [], kunden = [], alleMarker = [], selectedPoints = [], routeLine = null;

  async function ladeDaten(){
    setStatus("Lade Daten‚Ä¶");
    const firmenRows = await loadCsvAsObjects(sheetUrlFirmen);
    const kundenRows = await loadCsvAsObjects(sheetUrlKunden);

    werke = normalizePreise(parseFirmen(firmenRows)).map(w=>{
      const ds = datasetFromProdukt(w.produkt);
      return { ...w, dataset: ds, productType: ds };
    });
    kunden = parseKunden(kundenRows);

    setStatus(`Geladen:\nFirmen: ${werke.length}\nKunden: ${kunden.length}\n\nGeocoding l√§uft‚Ä¶`);
  }

  async function buildMap(){
    alleMarker = [];
    const bounds = L.latLngBounds();

    let okF=0, okK=0;

    // Firmen
    for(const w of werke){
      const q1 = `${(w.plz||"").trim()} ${(w.ort||"").trim()}, ${(w.land||"").trim()}`.replace(/\s+/g," ").trim();
      const q2 = `${(w.ort||"").trim()}, ${(w.land||"").trim()}`.replace(/\s+/g," ").trim();
      const q3 = `${(w.ort||"").trim()}`.trim();

      const c = await geocodeWithFallback([q1,q2,q3]);
      if(!c) continue;
      okF++;

      const circle = L.circleMarker([c.lat,c.lon],{
        radius:8,
        color:w.farbe,
        fillColor:w.farbe,
        fillOpacity:0.85
      }).bindTooltip("", {sticky:true})
        .on("tooltipopen", ()=> circle.getTooltip().setContent(tooltipHtmlFirma(w)))
        .on("click",()=>handleMarkerClick(w.firma,c));

      alleMarker.push({
        type:"firma",
        marker: circle,
        firma:w.firma,
        ort:w.ort,
        plz:w.plz,
        land:w.land,
        preis:w.preis,
        farbe:w.farbe,
        zert:(w.zert||"").toLowerCase(),
        country_code:(c.country_code||""),
        dataset:w.dataset,
        productType:w.productType
      });

      bounds.extend([c.lat,c.lon]);
    }

    // Kunden
    for(const k of kunden){
      const q1 = `${(k.plz||"").trim()} ${(k.ort||"").trim()}, ${(k.land||"").trim()}`.replace(/\s+/g," ").trim();
      const q2 = `${(k.ort||"").trim()}, ${(k.land||"").trim()}`.replace(/\s+/g," ").trim();
      const q3 = `${(k.ort||"").trim()}`.trim();

      const c = await geocodeWithFallback([q1,q2,q3]);
      if(!c) continue;
      okK++;

      const m = L.marker([c.lat,c.lon],{icon:blauesDreieck})
        .bindTooltip(`<b>${k.name}</b><br>${k.ort}${k.plz ? " " + k.plz : ""}${k.land ? "<br>" + k.land : ""}`,{sticky:true})
        .on("click",()=>handleMarkerClick(k.name,c));

      alleMarker.push({ type:"kunde", marker:m, country_code:(c.country_code||"") });
      bounds.extend([c.lat,c.lon]);
    }

    setStatus(`${statusBox.textContent}\n\nGeocode Treffer:\nFirmen: ${okF}/${werke.length}\nKunden: ${okK}/${kunden.length}`);

    if(bounds.isValid()) map.fitBounds(bounds.pad(0.15));
    updateLayers();

    // Wenn hier 0/‚Ä¶ steht, sieht man nix -> Geocoding Problem
    if (okF===0 && okK===0) {
      alert("Geocoding hat keine Treffer geliefert. Pr√ºfe Ort/PLZ/Land Schreibweise in den Tabellen.");
    }
  }

  // Filter
  function getSelectedCountries() {
    const chks = document.querySelectorAll(".countryChk");
    const selected = [];
    chks.forEach(ch => { if (ch.checked) selected.push(ch.value); });
    if (selected.length === 0 || selected.includes("all")) return ["all"];
    return selected;
  }

  function updateCountryButtonLabel() {
    const btn = document.getElementById("countryDropdownBtn");
    if (!btn) return;
    const selected = getSelectedCountries();
    if (selected.length === 1 && selected[0] === "all") btn.textContent = "Alle L√§nder";
    else {
      const names = {de:"DE",at:"AT",pl:"PL",cz:"CZ",fr:"FR",ch:"CH",be:"BE",sk:"SK"};
      btn.textContent = selected.map(c => names[c] || c.toUpperCase()).join(", ");
    }
  }

  function updateLayers(){
    // remove
    alleMarker.forEach(m=>{ if (m.marker && map.hasLayer(m.marker)) map.removeLayer(m.marker); });

    const selectedCountries = getSelectedCountries();
    const noCountryFilter = selectedCountries.length === 1 && selectedCountries[0] === "all";

    const en   = document.getElementById("chkEnPlus")?.checked ?? true;
    const din  = document.getElementById("chkDINplus")?.checked ?? true;
    const sure = document.getElementById("chkSURE")?.checked ?? true;
    const cpp  = document.getElementById("chkCPP")?.checked ?? true;
    const ohne = document.getElementById("chkOhneZert")?.checked ?? true;

    const gruen  = document.getElementById("chkGruen")?.checked ?? true;
    const orange = document.getElementById("chkOrange")?.checked ?? true;
    const rot    = document.getElementById("chkRot")?.checked ?? true;
    const grau   = document.getElementById("chkGrau")?.checked ?? true;

    const kundenFlag = document.getElementById("chkKunden")?.checked ?? true;

    const showHacks = document.getElementById("chkHackschnitzel")?.checked ?? true;
    const showSaeg  = document.getElementById("chkSaegespaene")?.checked ?? true;

    for(const m of alleMarker){
      if(m.type === "kunde"){
        if (kundenFlag) {
          if (noCountryFilter || (m.country_code && selectedCountries.includes(m.country_code))) {
            map.addLayer(m.marker);
          }
        }
        continue;
      }

      if (m.productType === "hackschnitzel" && !showHacks) continue;
      if (m.productType === "saegespaene"   && !showSaeg)  continue;

      const z = (m.zert || "");
      let zertOK = false;
      if(z.includes("enplus") && en) zertOK = true;
      if(z.includes("dinplus") && din) zertOK = true;
      if(z.includes("sure") && sure) zertOK = true;
      if(z.includes("cpp") && cpp) zertOK = true;
      if(!z && ohne) zertOK = true;
      if(!zertOK) continue;

      if (!noCountryFilter) {
        if (!m.country_code || !selectedCountries.includes(m.country_code)) continue;
      }

      const aktiveFarbe = m.farbe;
      const isGruen  = aktiveFarbe === "green";
      const isOrange = aktiveFarbe === "orange";
      const isRot    = aktiveFarbe === "red";
      const isGrau   = aktiveFarbe === "#9e9e9e";

      let sichtbar = false;
      if(isGruen && gruen) sichtbar = true;
      if(isOrange && orange) sichtbar = true;
      if(isRot && rot) sichtbar = true;
      if(isGrau && grau) sichtbar = true;
      if(!sichtbar) continue;

      map.addLayer(m.marker);
    }
  }

  // Route
  function handleMarkerClick(label,coord){
    selectedPoints.push({label,coord});
    if(selectedPoints.length===2){
      const [a,b]=selectedPoints;
      showRoute(a,b);
      selectedPoints=[];
    }
  }

  async function showRoute(a,b){
    const url = `https://router.project-osrm.org/route/v1/driving/${a.coord.lon},${a.coord.lat};${b.coord.lon},${b.coord.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();
    if(!(data.routes && data.routes.length)){
      alert("Keine Route gefunden!");
      return;
    }

    const route = data.routes[0];
    const distKm = route.distance / 1000;
    const dist = distKm.toFixed(1);
    const durationMin = route.duration / 60;
    const hours = Math.floor(durationMin/60);
    const minutes = Math.round(durationMin%60);
    const durationStr = hours>0?`${hours}h ${minutes}min`:`${minutes}min`;
    const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);

    const werkA = werke.find(w => w.firma === a.label);
    const werkB = werke.find(w => w.firma === b.label);
    const firmeneintrag = werkA || werkB;
    const firmenPreis = firmeneintrag ? (firmeneintrag.preis || 0) : 0;

    const preisProKm = distKm < 250 ? 2.15 : 1.85;
    const teilstrecke = distKm / 24;
    const berechnung = teilstrecke * preisProKm;
    const gesamt = (berechnung + (firmenPreis||0)) * 1.05;

    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords,{color:'blue',weight:5,opacity:0.8}).addTo(map);

    const mid = coords[Math.floor(coords.length/2)];
    L.popup().setLatLng(mid).setContent(`
      <b>Route:</b> ${a.label} ‚Üî ${b.label}<br>
      <b>Entfernung:</b> ${dist} km<br>
      <b>Dauer:</b> ${durationStr}<br>
      <b>Preis pro km:</b> ${preisProKm.toFixed(2)} ‚Ç¨<br>
      <b>Werkspreis:</b> ${(firmenPreis||0).toFixed(2)} ‚Ç¨<br>
      <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${gesamt.toFixed(2)} ‚Ç¨</span>
    `).openOn(map);

    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
  }

  // UI Events
  document.addEventListener("change", e => {
    if (e.target && e.target.matches('input[type="checkbox"]')) {
      if (e.target.classList.contains("countryChk")) {
        if (e.target.value === "all" && e.target.checked) {
          document.querySelectorAll(".countryChk").forEach(ch => { if (ch.value !== "all") ch.checked = false; });
        } else if (e.target.value !== "all" && e.target.checked) {
          const allChk = document.querySelector('.countryChk[value="all"]');
          if (allChk) allChk.checked = false;
        }
        updateCountryButtonLabel();
      }
      updateLayers();
    }
  });

  const countryBtn = document.getElementById("countryDropdownBtn");
  if (countryBtn) {
    countryBtn.addEventListener("click", () => {
      const menu = document.getElementById("countryDropdownMenu");
      if (!menu) return;
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
    });
  }

  document.addEventListener("click", (e) => {
    const dd = document.getElementById("countryDropdown");
    const menu = document.getElementById("countryDropdownMenu");
    if (!dd || !menu) return;
    if (!dd.contains(e.target)) menu.style.display = "none";
  });

  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.addEventListener("keydown", e => {
      if(e.key === "Enter"){
        const query = e.target.value.toLowerCase().trim();
        if(!query) return;

        const treffer = alleMarker.find(m =>
          m.marker &&
          m.marker.getTooltip &&
          m.marker.getTooltip().getContent &&
          String(m.marker.getTooltip().getContent()).toLowerCase().includes(query)
        );

        if(treffer){
          const latlng = treffer.marker.getLatLng();
          map.setView(latlng,9);
          treffer.marker.openTooltip();
        } else alert("Kein Treffer gefunden.");
      }
    });
  }

  (async ()=>{
    try{
      await ladeDaten();
      await buildMap();
    }catch(err){
      setStatus("FEHLER:\n" + (err?.message || String(err)));
      console.error(err);
    }
  })();
</script>

</body>
</html>
