<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produktwerke ‚Äì Europa Karte</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body{height:100%;margin:0;}
    #map{width:100%;height:100%;}

    .legend, .cert-box{
      position:absolute;background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);font:14px/1.3 system-ui,Arial,sans-serif;
    }
    .cert-box{bottom:12px;left:12px;z-index:1000;}
    .legend{bottom:12px;right:12px;min-width:180px;z-index:3000;}

    .search-box{
      position:absolute;top:12px;right:12px;z-index:1500;background:#fff;
      padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px system-ui,Arial,sans-serif;width:280px;
    }
    .search-box input[type="text"]{
      width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;
      outline:none;box-sizing:border-box;margin-left:4px;
    }

    .cert-box hr{border:none;height:1px;background:#eee;margin:6px 0;}

    .country-dropdown{position:relative;display:block;width:100%;margin-top:8px;}
    .country-dropdown-button{
      width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;
      padding:4px 6px;text-align:left;cursor:pointer;box-sizing:border-box;
    }
    .country-dropdown-button:after{content:"‚ñæ";float:right;opacity:.6;}
    .country-dropdown-menu{
      position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;
      border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      z-index:4000;display:none;min-width:160px;max-height:260px;overflow-y:auto;
      padding:8px 10px;box-sizing:border-box;
    }
    .country-dropdown-menu label{
      display:flex;align-items:center;gap:8px;margin:6px 0;cursor:pointer;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Suche -->
<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶"/>
</div>

<!-- Zertifikate + Produkt -->
<div class="cert-box">
  <b>Produkt</b><br>
  <label><input type="checkbox" id="chkHackschnitzel" checked> Hackschnitzel</label><br>
  <label><input type="checkbox" id="chkSaegespaene" checked> S√§gesp√§ne</label>
</div>

<!-- Legende -->
<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label>
</div>

<script>
  // =======================
  // Karte
  // =======================
  const map = L.map("map", { maxZoom: 19 }).setView([51, 11], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    minZoom: 4, maxZoom: 19, attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  function colorForPrice(p, keinPreis) {
    if (keinPreis) return "#9e9e9e";
    if (!p || p <= 0 || isNaN(p)) return "#9e9e9e";
    if (p <= 260) return "green";
    if (p < 285) return "orange";
    return "red";
  }

  // =======================
  // Tabellen
  // =======================
  const sheetUrlFirmen = "https://docs.google.com/spreadsheets/d/1GIBV-WAyaslfi175jpbif0bHw8YWAhriifM7CtDUB2k/gviz/tq?tqx=out:csv&gid=0";

  async function loadCsv(url){
    const res = await fetch(url, { cache: "no-store" });
    const text = await res.text();
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    return parsed.data || [];
  }

  function parseFirmen(rows){
    return rows.map(x => ({
      firma: (x.firma||"").trim(),
      ort: (x.ort||"").trim(),
      plz: (x.plz||"").trim(),
      land: (x.land||"").trim(),
      produkt: (x.produkt||"").trim(),
      preis: parseFloat(String(x.preis||"0").replace(",", "."))
    })).filter(w => w.firma && w.ort);
  }

  function normalizePreise(daten){
    const g√ºltige = daten.filter(w => isFinite(w.preis) && w.preis > 0);
    const avg = g√ºltige.length ? (g√ºltige.reduce((a,b)=>a+b.preis,0)/g√ºltige.length) : 0;
    return daten.map(w=>{
      if(!isFinite(w.preis) || w.preis<=0){ w.preis=avg; w.keinPreis=true; } else w.keinPreis=false;
      w.farbe = colorForPrice(w.preis, w.keinPreis);
      return w;
    });
  }

  // =======================
  // Geocode (einfach)
  // =======================
  const geoCache = {};
  async function geocode(q){
    if(geoCache[q]) return geoCache[q];
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
    const d = await r.json();
    if(d && d.length){
      geoCache[q] = {lat:+d[0].lat, lon:+d[0].lon};
      return geoCache[q];
    }
    return null;
  }

  // =======================
  // State
  // =======================
  let werke = [];
  let alleMarker = [];

  // =======================
  // Daten laden
  // =======================
  async function ladeDaten(){
    const firmenRows = await loadCsv(sheetUrlFirmen);
    werke = normalizePreise(parseFirmen(firmenRows));
  }

  // =======================
  // Karte bauen
  // =======================
  async function buildMap(){
    alleMarker = [];
    const bounds = L.latLngBounds();

    for(const w of werke){
      const c = await geocode(`${w.plz} ${w.ort} ${w.land}`);
      if(!c) continue;

      const circle = L.circleMarker([c.lat,c.lon],{
        radius:8,
        color:w.farbe,
        fillColor:w.farbe,
        fillOpacity:0.85
      });

      circle.bindTooltip(`<b>${w.firma}</b><br>${w.ort}<br>${w.produkt}<br>${w.preis.toFixed(2)} ‚Ç¨`,{sticky:true});

      alleMarker.push({
        marker: circle,
        produkt: (w.produkt||"").toLowerCase(),
        farbe: w.farbe
      });

      bounds.extend([c.lat,c.lon]);
    }

    if(bounds.isValid()) map.fitBounds(bounds.pad(0.15));
    updateLayers();
  }

  // =======================
  // Filter
  // =======================
  function updateLayers(){
    alleMarker.forEach(m => { if(map.hasLayer(m.marker)) map.removeLayer(m.marker); });

    const showHacks = document.getElementById("chkHackschnitzel").checked;
    const showSaeg  = document.getElementById("chkSaegespaene").checked;

    const gruen  = document.getElementById("chkGruen").checked;
    const orange = document.getElementById("chkOrange").checked;
    const rot    = document.getElementById("chkRot").checked;
    const grau   = document.getElementById("chkGrau").checked;

    for(const m of alleMarker){
      const prod = m.produkt;

      const hasHacks = prod.includes("hackschnitzel");
      const hasSaeg  = prod.includes("s√§gesp√§ne") || prod.includes("saegespaene");

      // --- PRODUKT-FILTER ---
      if (showHacks && !showSaeg && !hasHacks) continue;
      if (!showHacks && showSaeg && !hasSaeg) continue;
      if (showHacks && showSaeg && !(hasHacks || hasSaeg)) continue;
      if (!showHacks && !showSaeg) continue;

      // --- FARB-FILTER ---
      const isGruen  = m.farbe === "green";
      const isOrange = m.farbe === "orange";
      const isRot    = m.farbe === "red";
      const isGrau   = m.farbe === "#9e9e9e";

      let sichtbar = false;
      if(isGruen && gruen) sichtbar = true;
      if(isOrange && orange) sichtbar = true;
      if(isRot && rot) sichtbar = true;
      if(isGrau && grau) sichtbar = true;
      if(!sichtbar) continue;

      map.addLayer(m.marker);
    }
  }

  document.addEventListener("change", e => {
    if (e.target && e.target.matches('input[type="checkbox"]')) {
      updateLayers();
    }
  });

  // =======================
  // Start
  // =======================
  (async ()=>{
    await ladeDaten();
    await buildMap();
  })();
</script>

</body>
</html>
